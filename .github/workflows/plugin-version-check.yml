name: Plugin Version Check

on:
  pull_request:
    paths:
      - 'plugins/**'

jobs:
  check-version-bump:
    name: Verify plugin version bump
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for version bump
        run: |
          PLUGIN_JSON="plugins/ralph-specum/.claude-plugin/plugin.json"
          BASE_BRANCH="${{ github.base_ref }}"

          # Get the version from the PR branch
          PR_VERSION=$(jq -r '.version' "$PLUGIN_JSON")

          # Get the version from the base branch
          BASE_VERSION=$(git show "origin/${BASE_BRANCH}:${PLUGIN_JSON}" 2>/dev/null | jq -r '.version')

          if [ -z "$BASE_VERSION" ] || [ "$BASE_VERSION" == "null" ]; then
            echo "✅ No base version found (new plugin). Current version: $PR_VERSION"
            exit 0
          fi

          echo "Base branch version: $BASE_VERSION"
          echo "PR branch version: $PR_VERSION"

          if [ "$PR_VERSION" == "$BASE_VERSION" ]; then
            echo ""
            echo "❌ ERROR: Plugin files changed but version was not bumped!"
            echo ""
            echo "Please update the version in $PLUGIN_JSON"
            echo "Current version: $BASE_VERSION"
            echo ""
            echo "To bump the version, update the 'version' field in plugin.json"
            exit 1
          fi

          # Compare versions to ensure it's actually a bump (not a downgrade)
          version_compare() {
            local v1=$1 v2=$2
            if [ "$v1" == "$v2" ]; then
              return 1
            fi
            local IFS=.
            local i v1_parts=($v1) v2_parts=($v2)
            for ((i=0; i<${#v1_parts[@]} || i<${#v2_parts[@]}; i++)); do
              local n1=${v1_parts[i]:-0}
              local n2=${v2_parts[i]:-0}
              if ((n1 > n2)); then
                return 0
              elif ((n1 < n2)); then
                return 1
              fi
            done
            return 1
          }

          if version_compare "$PR_VERSION" "$BASE_VERSION"; then
            echo ""
            echo "✅ Version bumped: $BASE_VERSION → $PR_VERSION"
          else
            echo ""
            echo "❌ ERROR: Version appears to be downgraded or invalid!"
            echo "Base version: $BASE_VERSION"
            echo "PR version: $PR_VERSION"
            echo ""
            echo "Please ensure the version is incremented, not decremented."
            exit 1
          fi
