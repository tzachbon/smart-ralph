# Progress: speckit-stop-hook

## Original Goal
Upgrade ralph-speckit's stop-watcher.sh to be a self-contained execution loop controller with JSON output format, matching the pattern established in ralph-specum's stop-watcher.sh (commit a939076). The speckit stop-watcher currently acts as a passive watcher that always exits 0 and just logs to stderr. It needs to become an active loop controller that outputs JSON continuation prompts ({decision: "block", reason: ..., systemMessage: ...}) to enable self-contained task execution without depending on an external ralph-loop plugin.

## Completed Tasks
- [x] 1.1 Rewrite stop-watcher.sh as self-contained loop controller
- [x] 1.2 Update implement.md to remove ralph-loop dependency
- [x] 1.3 Update cancel.md for self-contained cancellation
- [x] 1.4 Update state schema for forward compatibility
- [x] 1.5 Bump version to 1.0.0
- [x] 2.1 Align stop-watcher comments and structure with specum
- [x] 2.2 Verify implement.md coordinator prompt consistency
- [x] 3.1 Create speckit test helper setup.bash
- [x] 3.2 Create speckit-stop-hook.bats test suite

## Current Task
Awaiting next task

### Task 2.2: Verify implement.md coordinator prompt consistency
- All paths use `.specify/specs/$feature/` (14 occurrences, zero `./specs/`)
- All state file refs use `.speckit-state.json` (16 occurrences, zero `.ralph-state.json`)
- `ALL_TASKS_COMPLETE` signal referenced correctly (9 occurrences)
- Agent delegation refs: `spec-executor` (20+), `qa-engineer` (5)
- Error messages reference `/speckit:implement`, `/speckit:cancel`, `/speckit:start`, `/speckit:tasks`
- Zero stale specum references found — no changes needed

### Task 2.1: Align stop-watcher comments and structure with specum
- Reviewed all comments against specum reference pattern
- Improved section comment for feature resolution (line 32): clearer about fixed path vs path-resolver
- Added "Extract feature name and derive spec path" comment (line 38)
- Added "Section 10" reference to transcript cleanup comment (line 74) matching specum
- Verified: FEATURE_NAME used consistently (no SPEC_NAME), all error messages reference /speckit:* commands
- DESIGN NOTE present at correct location, header describes all 3 responsibilities
- bash -n syntax check: PASS

## Learnings
- Speckit stop-watcher is 56 lines (passive); specum is 195 lines (active controller). Gap is ~140 lines of new logic.
- Speckit uses `.specify/.current-feature` (not `specs/.current-spec`) and `.speckit-state.json` (not `.ralph-state.json`).
- Speckit state schema has `additionalProperties: false` — must change to `true` since recoveryMode/fixTaskMap fields need to be allowed.
- Speckit implement.md writes `.coordinator-prompt.md` and invokes `ralph-loop:ralph-loop` skill — both must be replaced with direct prompt output.
- Speckit cancel.md invokes `ralph-wiggum:cancel-ralph` — must be replaced with direct state file deletion.
- Existing test suite (`tests/stop-hook.bats`) and helpers (`tests/helpers/setup.bash`) test specum only; speckit needs its own test file with adapted paths.
- Specum has a `SessionStart` hook (`load-spec-context.sh`) that speckit lacks — out of scope for this change but noted for future.
- Version bump should be 1.0.0 (major) since removing ralph-loop dependency is a breaking change.
- Speckit hooks.json lacks `matcher: "*"` that specum has — should be added for consistency.
- New stop-watcher.sh is 191 lines. Port was straightforward: replaced path-resolver with fixed .specify/ path, updated all log prefixes and command references.
- End-to-end test confirmed JSON output with all 3 required fields (decision, reason, systemMessage).
- implement.md edit was straightforward: removed 3 sections (dependency check, write-to-file, skill invocation), added "Start Execution" section with design note matching specum pattern.

### Verification: 1.6 POC Checkpoint
- Status: PASS
- End-to-end JSON output: valid JSON with decision="block", reason (continuation prompt), systemMessage (status line)
- Edge cases tested: no state file (silent exit), non-execution phase (silent exit), corrupt JSON (error JSON output)
- Syntax check: bash -n passes (exit 0)
- implement.md external refs: 0 matches for ralph-loop|ralph-wiggum|coordinator-prompt
- cancel.md external refs: 0 matches for ralph-wiggum|cancel-ralph|Ralph Loop
- All checks passed

### Task 3.2: Create speckit-stop-hook.bats test suite
- Ported all 29 test cases from tests/stop-hook.bats to tests/speckit-stop-hook.bats
- Adapted assertions: "Continue feature:" instead of "Continue spec:", "test-feature" instead of "test-spec"
- Updated systemMessage assertion: "Ralph-speckit" instead of "Ralph-specum"
- Updated stderr assertions: "[ralph-speckit]" instead of "[ralph-specum]"
- All 29 tests pass on first run

## Next
Task 4.1: Local quality check
