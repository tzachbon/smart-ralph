# Progress: opencode-codex-support

## Original Goal

Introduce cross-tool support for OpenCode and Codex CLI alongside Claude Code in the Smart Ralph plugin.

Currently Smart Ralph is tightly coupled to Claude Code's plugin system (plugin.json manifest, markdown commands with YAML frontmatter, Task tool for subagent delegation, TeamCreate/SendMessage for team research, Stop/PreToolUse hooks for execution loop). The goal is to make the spec-driven workflow (research → requirements → design → tasks → execute) work natively across all three tools.

### What "full support" means:

1. **Portable Spec Format** — The spec artifacts (research.md, requirements.md, design.md, tasks.md, .progress.md, .ralph-state.json) should remain tool-agnostic. They already are mostly markdown/JSON — ensure no Claude Code-specific assumptions leak into templates or schemas.

2. **SKILL.md as the universal entry point** — SKILL.md is the one format shared identically across Claude Code, OpenCode, and Codex CLI. Convert the core Ralph workflow commands into SKILL.md files that any tool can discover and invoke (start, research, requirements, design, tasks, implement, status, cancel).

3. **AGENTS.md generation** — As part of the spec output, optionally generate an AGENTS.md file that OpenCode and Codex can read for project-level instructions derived from the spec's design decisions.

4. **Tool-specific adapters for execution** — The execution loop currently relies on Claude Code's Stop hook + Task tool. Create adapter layers:
   - **Claude Code**: Current stop-hook + Task tool delegation (no changes needed)
   - **OpenCode**: JS/TS plugin hooks (tool.execute.after, session.idle) + task subagent invocation
   - **Codex CLI**: No hooks available. Use MCP server approach — Ralph runs as an MCP server that Codex connects to, providing spec-executor as an MCP tool. Alternatively, rely on SKILL.md progressive disclosure to guide Codex through tasks sequentially.

5. **Team research portability** — Claude Code uses TeamCreate/SendMessage for parallel research.
   - **OpenCode**: Use its native subagent system (task tool with subagent type)
   - **Codex CLI**: Use MCP-based orchestration or fall back to sequential research via SKILL.md guidance

6. **Configuration bridge** — Create a unified ralph config that generates tool-specific configs:
   - Claude Code: .claude-plugin/plugin.json + .mcp.json + hooks/
   - OpenCode: opencode.json plugin entry + .opencode/commands/ + .opencode/agents/
   - Codex CLI: ~/.codex/config.toml MCP entry + .agents/skills/ SKILL.md files + AGENTS.md

### Constraints:
- Don't break existing Claude Code plugin functionality
- Spec file format must remain identical across tools (single source of truth)
- Start with SKILL.md portability (highest leverage, works everywhere) before tool-specific adapters
- OpenCode adapter should use its JS/TS plugin system for hooks, not shell scripts
- Codex adapter must work within Codex's limitations (no hooks, no custom commands, no custom agents)

### Success criteria:
- A user can run the Ralph spec workflow in OpenCode using `$ralph:start` or equivalent
- A user can run the Ralph spec workflow in Codex CLI using skill discovery
- Existing Claude Code users see zero regression
- Spec artifacts generated in one tool can be executed in another

## Interview Format
- Version: 1.0

## Intent Classification
- Type: GREENFIELD
- Confidence: high (5 keywords matched)
- Min questions: 5
- Max questions: 10
- Keywords matched: introduce, support, create, implement, build

## Completed Tasks
- [x] 1.1 Audit templates and schemas for Claude Code-specific references
- [x] 1.2 Create start SKILL.md
- [x] 1.3 Create research SKILL.md
- [x] 1.4 Create requirements, design, and tasks SKILL.md files
- [x] 1.5 Create implement SKILL.md (with Codex-compatible task progression)
- [x] 1.6 Create status and cancel SKILL.md files
- [x] 2.1 Create AGENTS.md generator
- [x] 2.2 Create OpenCode execution loop adapter
- [x] 2.3 Create Codex CLI adapter
- [x] 2.4 Create configuration bridge
- [x] 3.1 Test SKILL.md discoverability
- [x] 3.2 Test spec artifact portability
- [x] 3.3 Test zero regression for Claude Code plugin
- [x] 4.1 Documentation update
- [x] 4.2 Version bump
- [x] 4.4 Create PR and verify CI - PR #91

## Current Task
Awaiting next task

## Completed: 4.2
- [x] 4.2 Version bump - bumped 3.3.3 -> 3.4.0 in plugin.json and marketplace.json

## Learnings
- Spec artifacts (.ralph-state.json, .progress.md, templates, schemas) are already mostly tool-agnostic. Only minor audit needed.
- The 16 commands in commands/ all use Claude Code-specific YAML frontmatter (allowed-tools, argument-hint). These cannot be reused directly in other tools.
- 6 SKILL.md files already exist in the plugin (communication-style, delegation-principle, interview-framework, reality-verification, smart-ralph, spec-workflow). These prove the SKILL.md pattern works.
- The stop-watcher.sh is the most complex Claude Code-specific component (195 lines of bash). OpenCode adapter needs to replicate this in TypeScript.
- Codex CLI has the most limited feature set -- no hooks, no commands, no agents. SKILL.md progressive disclosure is the only viable approach for execution.
- The path-resolver.sh (bash functions) is portable and can be reused across adapters.
- Existing templates in templates/*.md contain no Claude Code-specific references -- they use generic markdown with mustache-style placeholders.
- Schema spec.schema.json is tool-agnostic (standard JSON Schema, no Claude Code references).
- The plan-synthesizer agent is the natural place to add AGENTS.md generation since it already generates all spec artifacts.
- MCP server approach for Codex is deferred to future work -- SKILL.md guidance provides 80% of value with 20% of effort.
- Task 1.1 audit: Templates had zero matches for primary Claude Code tool references (Task tool, AskUserQuestion, TeamCreate, SendMessage, Stop hook, subagent_type, allowed-tools). Only one minor Claude-specific path reference in settings-template.md (.claude/ralph-specum.local.md) was made tool-agnostic. Schema spec.schema.json is fully tool-agnostic.
- Task 1.2: SKILL.md progressive disclosure pattern: Level 1 = Overview (what it does), Level 2 = Steps (numbered how-to with code examples), Level 3 = Advanced Options (flags, edge cases). Existing SKILL.md files in the repo use YAML frontmatter with `name` and `description` fields. The start command has extensive logic (branch management, spec scanner, team research, quick mode) that was distilled into tool-agnostic instructions.
- Task 1.3: Research SKILL.md covers 8 steps: read goal, explore codebase, search web, discover quality commands, assess feasibility, find related specs, write research.md, update state. Includes parallel vs sequential research guidance (tool-agnostic framing). The research-analyst.md agent had extensive Claude Code-specific tool references (WebSearch, Glob, Grep, Read) that were abstracted to generic actions ("search the web", "find related files") in the SKILL.md.
- Task 1.4: Created three SKILL.md files (requirements, design, tasks) following same progressive disclosure pattern (Overview/Steps/Advanced). Each references the corresponding template format. Requirements covers user stories, FR/NFR tables, scope boundaries. Design covers architecture, components, data flow, technical decisions. Tasks covers POC-first 4-phase workflow, task format (Do/Files/Done when/Verify/Commit), quality checkpoints. All tool-agnostic with zero Claude Code-specific references.
- Task 1.5: Implement SKILL.md is the most detailed of all workflow skills. It covers the full execution loop: read state, find task, execute, verify, mark complete, commit, advance state, check completion. Includes three execution modes (automatic via hooks, semi-automatic via event hooks, manual re-invocation for Codex CLI). Includes jq commands for all state updates (advance, retry, initialize). The single-task invocation pattern enables Codex CLI to execute the full workflow without hooks -- each invocation handles one task and the state file preserves progress across invocations.
- Task 1.6: Status and cancel are utility skills. Status reads file system to infer phase (no state file = infer from artifact files, state file = read phase/taskIndex). Cancel has two levels: default (delete .ralph-state.json only, preserves artifacts) and --remove (delete entire spec directory). Both follow the same progressive disclosure pattern (Overview/Steps/Advanced) and include multi-root spec directory support for monorepos.

- Task 2.1: Created generate-agents-md.sh in plugins/ralph-specum/scripts/. The script uses awk for section extraction from design.md, properly handling fenced code blocks (skips ## headings inside ``` blocks). Supports --spec-path (required), --force (overwrite), --output (custom path). Extracts Architecture, Components, Technical Decisions, File Structure, and Existing Patterns sections. Combines Existing Patterns + Components into a Coding Conventions section. macOS sed is not compatible with GNU sed multi-line expressions -- use awk instead for portable text processing.

- Task 2.2: Created adapters/opencode/hooks/execution-loop.ts (~280 lines TypeScript) mirroring stop-watcher.sh logic. Key design decisions: (1) used node:fs and node:path only (zero external deps), (2) shared settings file format with Claude Code plugin (.claude/ralph-specum.local.md) so config is portable, (3) same HookResult shape (decision/reason/systemMessage) as the bash hook's JSON output, (4) includes all safety guards from bash version (global iteration limit, plugin disable check, transcript completion detection, orphaned progress file cleanup). README covers installation, opencode.json config, spec directory setup, troubleshooting.

- Task 2.3: Created adapters/codex/ with three files: (1) skills/ralph-implement/SKILL.md -- enhanced implement skill for Codex with full task-by-task guidance, jq commands for all state updates, explicit re-invocation prompts, and error recovery. (2) AGENTS.md.template -- mustache-style template with placeholders for spec_name, architecture_section, conventions_section, file_structure_section, decisions_section. (3) README.md -- covers setup (copy skill to .agents/skills/), AGENTS.md generation, workflow walkthrough for all 6 phases, hook-free execution explanation, troubleshooting. The Codex adapter is the simplest of the three (pure SKILL.md, no code) but the most verbose in documentation since users must drive the loop manually.

- Task 2.4: Created adapters/config/ with three files: (1) ralph-config.schema.json -- JSON Schema (draft 2020-12) defining tool-agnostic settings (spec_dirs, default_branch, commit_spec, max_iterations, max_task_iterations) plus per-tool config objects (claude_code, opencode, codex) each with enabled flag and tool-specific paths. (2) generate-config.sh -- idempotent bash script using jq that reads ralph-config.json, validates Claude Code plugin exists, creates/updates opencode.json with plugin entry, copies 8 workflow SKILL.md files to .opencode/commands/ and .agents/skills/, copies Codex-specific implement skill override, optionally runs generate-agents-md.sh for AGENTS.md. Supports --config, --dry-run flags. Has color-coded logging. (3) README.md -- covers format, fields, per-tool output, customization, idempotency, monorepo support. Dry-run test confirmed script discovers all 8 skills and both adapter paths correctly.

- Task 3.2: Created tests/test-artifact-portability.sh with 6 test groups (71 total checks): template tool-agnosticism (zero tool-specific refs across 9 templates), state file structure (10 required fields validated via jq), tasks.md format (frontmatter, checkboxes, phase headers, Do/Files/Done when/Verify/Commit sections), schema presence and tool-agnosticism (state definition with all 10 fields), cross-tool format consistency (OpenCode adapter TypeScript interface matches state file fields), and SKILL.md state documentation (implement SKILL.md documents all state fields, jq commands, task format). All 71 checks pass.

- Task 3.3: Created tests/test-claude-code-regression.sh with 11 test groups (35 total checks): plugin.json unchanged, hooks.json unchanged, stop-watcher.sh unchanged, command frontmatter validation (14 commands), agent frontmatter validation (8 agents), no files deleted, core file blob hash comparison, commands unchanged, agents unchanged, only additions (except allowed settings-template.md tweak), hook scripts directory structure. Uses git diff main, git rev-parse for blob hashes, and awk/sed for frontmatter parsing. All 35 checks pass.

- Task 3.1: Created tests/test-skill-discovery.sh with 8 test groups (51 total checks): file count, directory existence, YAML frontmatter (name/description), content after frontmatter (all >100 lines), progressive disclosure (## headings, >=2 per file), Overview section presence, tool-agnosticism (zero Claude Code-specific references), and broken file reference detection. All 51 checks pass. Used awk for frontmatter extraction (portable across macOS/GNU).

## Completed: 4.4
- [x] 4.4 Create PR and verify CI - PR https://github.com/tzachbon/smart-ralph/pull/91

## Next
All tasks complete

### Verification: 1.7 [VERIFY] POC Checkpoint -- SKILL.md completeness
- Status: PASS
- Check 1: SKILL.md count = 8 (expected 8) -- PASS
- Check 2: Claude Code tool-specific references (Task tool, AskUserQuestion, TeamCreate, allowed-tools, subagent_type) = 0 -- PASS
- Check 2b: "Claude Code" string appears in implement/SKILL.md Advanced section as part of a multi-tool comparison (alongside OpenCode and Codex CLI), not as a tool coupling -- acceptable
- Check 3: All 8 files have name: and description: YAML frontmatter -- PASS
- Check 4: All 8 files have progressive disclosure (## Overview, ## Steps, ## Advanced) -- PASS
- Check 5: Templates tool-agnostic (one minor example mention in settings-template.md, no structural dependency) -- PASS
- Check 6: Schema spec.schema.json has zero tool-specific references -- PASS

### Verification: 2.5 [VERIFY] Quality checkpoint -- Adapters and generators
- Status: PASS
- Check 1: Adapter directories exist (opencode, codex, config) -- PASS
  - adapters/opencode/: hooks/execution-loop.ts, README.md
  - adapters/codex/: skills/ralph-implement/SKILL.md, AGENTS.md.template, README.md
  - adapters/config/: ralph-config.schema.json, generate-config.sh, README.md
- Check 2: AGENTS.md generator works on existing spec -- PASS
  - Command: bash generate-agents-md.sh --spec-path ./specs/opencode-codex-support --force --output /tmp/test-agents.md
  - Exit code: 0
  - Generated AGENTS.md has all 4 sections: Architecture, Coding Conventions, File Structure, Key Decisions
- Check 3: OpenCode adapter TypeScript valid -- PASS
  - execution-loop.ts has proper exports (default export with name, description, hooks)
  - References .ralph-state.json reading via readState()
  - Has both session.idle and tool.execute.after hooks
  - Uses node:fs and node:path (zero external deps)
- Check 4: Codex adapter task progression -- PASS
  - SKILL.md mentions taskIndex (jq state commands, step 2 Read Execution State)
  - Has re-invocation guidance (step 8 "Re-invoke this skill to execute the next task")
  - Has jq commands for state updates (advance, retry, initialize)
- Check 5: Claude Code plugin unchanged -- PASS
  - git diff main -- plugins/ralph-specum/.claude-plugin/plugin.json: 0 lines (no changes)
  - git diff main -- plugins/ralph-specum/hooks/scripts/stop-watcher.sh: 0 lines (no changes)
  - git diff HEAD -- plugins/ralph-specum/.claude-plugin/plugin.json plugins/ralph-specum/hooks/: 0 lines

### Verification: 3.4 [VERIFY] Quality checkpoint -- All tests pass
- Status: PASS
- test-skill-discovery.sh: PASS (51 passed, 0 failed)
  - 8 SKILL.md files found, all with valid frontmatter, progressive disclosure, tool-agnosticism
- test-artifact-portability.sh: PASS (71 passed, 0 failed)
  - Templates, state files, tasks format, schema, cross-tool consistency all verified
- test-claude-code-regression.sh: PASS (35 passed, 0 failed)
  - plugin.json, hooks.json, stop-watcher.sh unchanged; all commands/agents intact; additions only
- File placement check: PASS -- all 27 changed files in correct directories
- Git status check: PASS -- only auto-generated index files modified (specs/.index/)
- Total: 157 checks passed, 0 failed

### Verification: 4.3 Local quality check
- Status: PASS (after fix)
- test-skill-discovery.sh: PASS (51 passed, 0 failed)
- test-artifact-portability.sh: PASS (71 passed, 0 failed)
- test-claude-code-regression.sh: PASS (35 passed, 0 failed) -- required fix
  - Initial run: 3 failures (tests 1, 7, 10) all related to plugin.json version bump
  - Root cause: regression test treated version-only diff in plugin.json as failure
  - Fix: updated tests 1, 7, 10 to allow version-only changes (required per CLAUDE.md)
  - After fix: all 35 checks pass
- git status --porcelain: 0 uncommitted files (clean working tree)
- Total: 157 checks passed, 0 failed
- Commit: fix(quality): allow version-only plugin.json changes in regression tests
