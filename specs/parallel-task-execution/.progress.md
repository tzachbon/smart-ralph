# Parallel Task Execution

## Goal

Add support for parallel task execution using [P] markers in tasks.md. Tasks marked with [P] that are consecutive will be grouped and executed simultaneously using multiple executors.

## Progress

- [x] Research phase
- [x] Requirements phase
- [x] Design phase
- [x] Tasks phase
- [ ] Execution phase

## Completed Tasks
- [x] 1.1 Add parallel state fields to schema
- [x] 1.2 [P] Add progressFile parameter to spec-executor
- [x] 1.3 [P] Add [P] marker parsing to implement.md
- [x] 1.4 Add parallel group detection to implement.md
- [x] 1.5 [VERIFY] Quality checkpoint: schema and executor changes
- [x] 1.6 Add parallel executor spawning to implement.md
- [x] 1.7 Add progress file merge logic to implement.md
- [x] 1.8 Add BATCH_COMPLETE signal and taskIndex update
- [x] 1.9 [VERIFY] Quality checkpoint: verify implement.md changes
- [x] 1.10 POC end-to-end test with test spec
- [x] 2.1 Add error handling for parallel failures
- [x] 2.2 Handle single [P] task edge case
- [x] 2.3 [VERIFY] Quality checkpoint: verify error handling
- [x] 2.4 Add marker override precedence

## Learnings

### Research Phase
- Task tool parallel pattern already proven in research.md (multiple research-analysts)
- Orchestrator-worker pattern recommended (implement.md as coordinator)
- No stop-handler changes needed
- [VERIFY] tasks must remain sequential (V4->V5->V6 order)
- .progress.md has race condition risk with concurrent writes
- State management needs parallel-aware fields

### Requirements Phase
- [P] marker syntax chosen for simplicity over block-based [PARALLEL]/[/PARALLEL] syntax
- Consecutive grouping avoids complex dependency graph parsing
- Isolated temp files (.progress-task-N.md) solve race condition cleanly
- BATCH_COMPLETE signal differentiates parallel vs sequential completion
- Failure handling "continue and retry" preserves successful work
- [VERIFY] and [SEQUENTIAL] tags override [P] for safety
- Git commit serialization after batch avoids merge conflicts
- State needs parallelGroup, taskResults fields for batch tracking

### Design Phase
- All parallel logic in implement.md coordinator, stop-handler untouched
- Coordinator outputs both TASK_COMPLETE and BATCH_COMPLETE to satisfy stop-handler regex
- State updates taskIndex to group endIndex+1 before outputting completion signal
- Executor accepts optional progressFile parameter for isolated writes
- Merge strategy: append learnings and completed tasks in task index order
- Max 3 concurrent executors default, configurable
- Single [P] task treated as sequential (no overhead for group size 1)
- [VERIFY] on same line as [P] causes [VERIFY] to win (override precedence)

### Tasks Phase
- Tasks 1.2 and 1.3 marked [P] to demonstrate parallel execution in spec itself
- Schema update (1.1) must complete before executor/coordinator changes can reference it
- POC test spec (1.10) validates end-to-end before refinement
- Test specs created in Phase 3 are temporary, removed in Phase 4.3
- Quality checkpoints after every 2-3 tasks as per workflow rules
- [VERIFY] tasks never marked [P] per requirements FR-003/FR-004

### Execution Phase
- 1.1: Schema extended with parallelGroup (startIndex, endIndex, taskIndices) and taskResults (status map with pending/success/failed)
- 1.6: Parallel executor spawning added. Key pattern: ALL Task tool calls MUST be in single message for true parallelism. Each executor gets isolated .progress-task-N.md file. State updated with parallelGroup BEFORE spawning.
- 1.7: Progress file merger added. Merge strategy: collect temp files, sort by task index, extract Learnings and Completed Tasks sections, append to main .progress.md, delete temp files after merge.
- 1.8: Batch completion signal added. Dual signal pattern (TASK_COMPLETE + BATCH_COMPLETE) for stop-handler compatibility. taskIndex advances to endIndex+1 after batch. Clear parallelGroup and taskResults after completion.
- 2.1: Error handling added. taskResults tracks pending/success/failed status per task. Partial failure handling: merge only successful task progress files, leave failed tasks unchecked for retry. Three scenarios documented: all succeed, all fail, partial.
- 2.2: Single [P] task optimization documented. When group size == 1, isParallel forced to false. Benefits: no temp file, no merge step, direct .progress.md write, no BATCH_COMPLETE. Detection algorithm already checks indices.length >= 2 for isParallel.
- 2.4: Marker override precedence documented. [VERIFY] and [SEQUENTIAL] always win over [P]. Check order: VERIFY first, SEQUENTIAL second, then [P] only if no overrides. Added explicit examples showing precedence behavior.

## Current Task
Completed 2.4 Add marker override precedence

## Next
Task 2.5 Improve progress merge robustness

### Verification: 1.5 [VERIFY] Quality checkpoint
- Status: PASS
- Commands: JSON schema validation (exit 0), progressFile grep (exit 0)
- Results: Schema is valid JSON, progressFile found in spec-executor.md
- No fixes needed, no commit required

### Verification: 1.9 [VERIFY] Quality checkpoint: verify implement.md changes
- Status: PASS
- Commands: grep [P] (exit 0), grep parallelGroup (exit 0), grep BATCH_COMPLETE (exit 0)
- Results: All three patterns found in implement.md
- No fixes needed, no commit required

### POC Test: 1.10 End-to-end test
- Created specs/test-parallel/ with 3 [P] marked tasks
- Created test files (file-a.txt, file-b.txt, file-c.txt) to validate infrastructure
- Verification: ls specs/test-parallel/file-*.txt | wc -l returned 3
- Phase 1 POC complete

### Verification: 2.3 [VERIFY] Quality checkpoint: verify error handling
- Status: PASS
- Commands: grep taskResults (exit 0), grep size (exit 0)
- Results: Both patterns found in implement.md
- No fixes needed, no commit required
