# Progress: fix-impl-context-bloat

## Original Goal
The current main implementation skill spams git diff which bloat the context. It needs to patiently wait for the other team members to wait and respond to him. The main agent should avoid consuming too many tokens.

## Interview Format
- Version: 1.0

## Intent Classification
- Type: REFACTOR
- Confidence: high (3 keywords matched)
- Min questions: 3
- Max questions: 5
- Keywords matched: fix, improve, bloat

## Learnings
- Layers 2 and 3 are fully redundant: spec-executor already commits and marks [x] before TASK_COMPLETE, and the stop-watcher also enforces 4 of 5 layers independently
- The stop-watcher already has an abbreviated prompt (lines 207-212 comment) — the task block inline approach extends this design intent
- Artifact review (Layer 5) reads design.md + requirements.md + changed files + invokes spec-reviewer per task — for 20 tasks that is 20x static file reads and 20 reviewer invocations
- coordinator-pattern.md State Update already uses `git diff --cached --quiet` pattern but verification-layers.md Layer 5 uses `git diff` for changed file collection — needs --name-only
- Research phase parallel-research.md already has a good "patient waiting" pattern that should be mirrored in execution phase
- Six files need coordinated changes: coordinator-pattern.md, verification-layers.md, commit-discipline.md, stop-watcher.sh, implement.md, and possibly the stop-watcher comment on line 228
- Scope decision: periodic review at every 5th task + phase boundaries + final task balances coverage vs token cost
- Design: 6 files need changes, not 5 — spec-executor.md Completion Integrity section references "4 verification layers" from the coordinator, needs update to 3
- Task block extraction uses awk counting approach (count task lines matching `- [[ x]]` to find 0-based index) — this is fragile if tasks.md has non-standard formatting but matches existing stop-watcher patterns
- State Update git commands in coordinator-pattern.md already use `git diff --cached --quiet` — no change needed there
- The parallel-research.md Step 5 "Wait and Shutdown" pattern is minimal — the patient waiting directive for execution needs to be more explicit about NOT polling TaskList
- Design revision: stop-watcher.sh line 228 references "4 layers" not "5" — verification-layers.md has 5 but stop-watcher only enforced 4 (skipped artifact review)
- Design revision: awk task extraction needs blank line handling within task blocks and documented out-of-bounds behavior
- Design revision: commit-discipline.md lines 64-65 already correct with `git diff --cached --quiet` — confirmed no changes needed
- Task planning: 40 tasks across 5 phases. Phase 1 (24 tasks) covers all 6 file edits with quality checkpoints every 2-3 tasks. Phase 2 (6 tasks) cleans orphaned references. Phase 3 (9 tasks) verifies behavioral correctness. Phase 4-5 (4+4 tasks) handles PR lifecycle.
- Task planning: spec-executor.md has a second stale reference in State File Protection (line ~494) -- "checkmark count mismatch" -- needs update in Phase 2 task 2.5
- Task planning: No build/lint/typecheck commands exist for this plugin. All quality verification uses grep-based content checks and `bash -n` shell syntax validation.
- Task planning: Tasks ordered by file to minimize context switches: verification-layers.md first (most changes), then coordinator-pattern.md, commit-discipline.md, stop-watcher.sh, implement.md, spec-executor.md
- Task planning revision: Removed Phase 5 (PR Lifecycle) -- task 4.2 already covers PR creation and CI verification. Merged CI monitoring into Phase 4. Removed unbounded code review resolution (out of scope). Final count: 41 tasks across 4 phases.
- Phase 2 audit: verification-layers.md had 3 orphaned "Layer 5" references in Review Loop prose (lines 64, 128, 143) that were missed during Phase 1 heading renumbering. All changed to "Layer 3".

### Verification: 1.4 [VERIFY] Quality checkpoint: verify verification-layers.md layer removal
- Status: PASS
- Checks: No "Uncommitted Spec Files" (old Layer 2) found, no "Checkmark Verification" (old Layer 3) found, "## Layer 2: TASK_COMPLETE" heading confirmed present
- Note: Layer 5 and old summary/self-verification sections remain (addressed by tasks 1.5-1.8)

### Verification: 1.9 [VERIFY] Quality checkpoint: full verification-layers.md validation
- Status: PASS
- Checks:
  - "Three verification layers" present: PASS
  - "## Layer 1: Contradiction Detection" heading: PASS
  - "## Layer 2: TASK_COMPLETE Signal Verification" heading: PASS
  - "## Layer 3: Artifact Review" heading: PASS
  - No "## Layer 4" heading: PASS (not found)
  - No "## Layer 5" heading: PASS (not found)
  - "### When to Run" periodic rules section: PASS
  - "All 3 layers" in verification summary: PASS
  - Exactly 3 "^## Layer" headings total: PASS

### Verification: 1.14 [VERIFY] Quality checkpoint: coordinator-pattern.md verification section
- Status: PASS
- Checks:
  - "all 3 in the Verification" in integrity rules: PASS
  - "these 3 verifications" in verification section intro: PASS
  - "All 3 layers" in verification summary: PASS
  - No stale Layer 4/5 references: PASS (0 matches)
  - All 5 "Layer" occurrences are correct new-numbering (Layer 1, 2, 3 headings + section heading + cross-reference): PASS

### Verification: 1.19 [VERIFY] Quality checkpoint: stop-watcher.sh changes
- Status: PASS
- Checks:
  - Shell syntax valid (bash -n exit 0): PASS
  - TASK_BLOCK variable present (lines 208, 211, 213, 240): PASS
  - "## Current Task" section in continuation prompt (line 239): PASS
  - "3 layers" reference in prompt (line 250): PASS

### Verification: 1.23 [VERIFY] Quality checkpoint: all 6 files layer count consistency
- Status: PASS
- Command: `grep -l "all 5 verification|all 4 verification|5 verification layers|4 verification layers"` across all 6 files
- Result: Zero matches (grep exit code 1 = no matches found)
- Files checked: verification-layers.md, coordinator-pattern.md, commit-discipline.md, stop-watcher.sh, implement.md, spec-executor.md
- Conclusion: No stale "5 layers" or "4 layers" references remain in any modified file

### Verification: 1.24 POC Checkpoint
- Status: PASS
- All 6 files verified end-to-end:
  - verification-layers.md: 3 layers (PASS), periodic rules (PASS), --name-only (PASS), updated summary (PASS), updated self-verification (PASS) -- 11/11 checks
  - coordinator-pattern.md: 3 layers (PASS), periodic artifact review (PASS), patient waiting (PASS), auto-pass rule (PASS) -- 10/10 checks
  - commit-discipline.md: Layers 1-2 reference (PASS), no old Layer 3 ref (PASS) -- 2/2 checks
  - stop-watcher.sh: shell syntax valid (PASS), TASK_BLOCK (PASS), Current Task section (PASS), 3 layers (PASS) -- 4/4 checks
  - implement.md: 3 layers (PASS), all 3 verification layers (PASS), no old all 5 (PASS) -- 3/3 checks
  - spec-executor.md: 3 verification layers (PASS), periodic artifact review (PASS), no stale refs (PASS) -- 4/4 checks
- Cross-file stale reference check: PASS (zero matches for old layer counts)

## Completed Tasks
- [x] 1.1 Update opening line and remove Layer 2 from verification-layers.md
- [x] 1.2 Remove Layer 3 (Checkmark Verification) from verification-layers.md
- [x] 1.3 Renumber Layer 4 to Layer 2 in verification-layers.md
- [x] 1.4 [VERIFY] Quality checkpoint: verify verification-layers.md layer removal
- [x] 1.5 Renumber Layer 5 to Layer 3 and add periodic rules in verification-layers.md
- [x] 1.6 Update git diff to --name-only in verification-layers.md review delegation prompt
- [x] 1.7 Update Verification Summary in verification-layers.md
- [x] 1.8 Update Spec-Executor Self-Verification section in verification-layers.md
- [x] 1.9 [VERIFY] Quality checkpoint: full verification-layers.md validation
- [x] 1.10 Update Integrity Rules layer count in coordinator-pattern.md
- [x] 1.11 Replace Verification Layers section in coordinator-pattern.md -- remove layers 2+3
- [x] 1.12 Renumber remaining layers in coordinator-pattern.md Verification section
- [x] 1.13 Update Verification Summary in coordinator-pattern.md
- [x] 1.14 [VERIFY] Quality checkpoint: coordinator-pattern.md verification section
- [x] 1.15 Add patient waiting directive to coordinator-pattern.md parallel Step 5
- [x] 1.16 Update Layer reference in commit-discipline.md State File Protection
- [x] 1.17 Add task block extraction function to stop-watcher.sh
- [x] 1.18 Update continuation prompt in stop-watcher.sh to inline task block
- [x] 1.19 [VERIFY] Quality checkpoint: stop-watcher.sh changes
- [x] 1.20 Update "5 layers" to "3 layers" in implement.md Step 4 reference
- [x] 1.21 Update "all 5 verification layers" to "all 3" in implement.md Key Coordinator Behaviors
- [x] 1.22 Update Completion Integrity section in spec-executor.md
- [x] 1.23 [VERIFY] Quality checkpoint: all 6 files layer count consistency
- [x] 1.24 POC Checkpoint
- [x] 2.1 Audit verification-layers.md for orphaned "Layer 4" or "Layer 5" references in prose
- [x] 2.2 Audit coordinator-pattern.md for orphaned layer references -- none found
- [x] 2.3 [VERIFY] Quality checkpoint: cross-file consistency audit -- PASS
- [x] 2.4 Ensure stop-watcher.sh DESIGN NOTE comment is accurate -- already correct
- [x] 2.5 Verify spec-executor.md State File Protection section is consistent - 459d76a
- [x] 2.6 [VERIFY] Quality checkpoint: post-refactoring validation -- PASS (fixed failure-recovery.md stale "5 verification" ref)

### Verification: 2.3 [VERIFY] Quality checkpoint: cross-file consistency audit
- Status: PASS
- All 6 files checked for stale references (5 verification, 4 verification, Layer 4/5, uncommitted spec files check, checkmark mismatch)
- Zero stale references found

### Verification: 2.6 [VERIFY] Quality checkpoint: post-refactoring validation
- Status: PASS (after fix)
- Shell syntax valid: PASS
- Initial run found stale "5 verification layers" in failure-recovery.md line 426 (not in original 6-file scope but caught by verify grep on references/)
- Fixed: changed to "3 verification layers"
- Re-run: PASS

## Current Task
Awaiting next task

## Learnings
- failure-recovery.md (line 426) also referenced "5 verification layers" -- not in the original 6-file change set but discovered during post-refactoring validation

## Next
Task 3.1: Verify verification-layers.md has exactly 3 layer headings
