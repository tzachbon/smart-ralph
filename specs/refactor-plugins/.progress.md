# Progress: refactor-plugins

## Original Goal
Refactor the plugins in here using the /plugin-dev skills

## Status
- Phase: research
- Started: 2026-01-29

## Interview Format
- Version: 1.0

## Intent Classification
- Type: REFACTOR
- Confidence: high (1 keyword matched)
- Min questions: 3
- Max questions: 5
- Keywords matched: refactor

## Interview Responses

### Goal Interview (from start.md)
- Problem: Improve all plugins according to plugin-dev skills best practices
- Constraints: Use only plugin-dev skills to improve all plugins
- Success criteria: Plugins follow plugin-dev best practices

## Completed Tasks

- [x] Read all plugin-dev skills (plugin-structure, command-development, skill-development, agent-development, hook-development)
- [x] Analyzed ralph-specum plugin structure (plugin.json, commands, agents, skills, hooks)
- [x] Analyzed ralph-speckit plugin structure (plugin.json, commands, agents, skills, hooks)
- [x] Created research.md with comprehensive gap analysis
- [x] 1.1 Add color and examples to ralph-specum agents (8 files)
- [x] 1.2 Add color and examples to ralph-speckit agents (6 files)
- [x] 1.4 Add version to ralph-specum skills (6 files)
- [x] 1.5 Add version and fix descriptions for ralph-speckit skills (4 files)
- [x] 1.6 Add matcher field to hooks (2 files) - 8301b94
- [x] 1.8 Add name field to ralph-speckit modern commands (5 files) - 34bd45b
- [x] 1.9 Migrate legacy commands to commands/ directory (8 files) - 0f617ad
- [x] 1.10 Remove legacy commands directory - b4b6a10
- [x] 1.12 Create validation script - 16fdced
- [x] 1.13 Update CLAUDE.md with best practices
- [x] 2.1 Create failure-recovery skill
- [x] 2.2 Create verification-layers skill
- [x] 2.3 Create coordinator-pattern skill
- [x] 2.5 Create branch-management skill
- [x] 2.6 Create intent-classification skill
- [x] 2.7 Create spec-scanner skill
- [x] 2.8 Create parallel-research skill
- [x] 2.10 Create phase-rules skill
- [x] 2.11 Create commit-discipline skill
- [x] 2.12 Create quality-checkpoints skill
- [x] 2.13 Create quality-commands skill
- [x] 2.15 Simplify implement.md command
- [x] 2.16 Simplify start.md command
- [x] 2.17 Simplify research.md command
- [x] 2.18 Simplify design.md, requirements.md, tasks.md commands - 8be1abf
- [x] 2.19 [VERIFY] Quality checkpoint: command simplification
- [x] 2.20 Simplify spec-executor.md agent
- [x] 2.21 Simplify task-planner.md agent
- [x] 2.22 Simplify research-analyst.md agent

## Current Task

Awaiting next task

## Learnings

### Task 2.22: Simplify research-analyst.md agent
- Reduced from 355 lines to 235 lines (34% reduction)
- Added skill reference: quality-commands
- Removed inline Quality Command Discovery section (~64 lines of discovery patterns)
- Kept essential identity: verify-first methodology, research methodology steps, related specs discovery
- Kept output template (research.md structure) but simplified it
- Kept communication style and anti-patterns
- Kept final step (awaitingApproval) as it's agent-specific state management

### Task 2.21: Simplify task-planner.md agent
- Reduced from 538 lines to 286 lines (47% reduction)
- Added skill references: phase-rules, quality-checkpoints
- Removed inline POC workflow (5 phases detailed description)
- Removed inline quality checkpoint rules and [VERIFY] task format examples
- Removed full Tasks Structure template with all phase examples
- Kept essential identity: E2E validation rules, no manual tasks, no new spec directories
- Kept task format, requirements, commit conventions, communication style, output structure
- Kept final step (awaitingApproval) as it's command-specific state management

### Task 2.20: Simplify spec-executor.md agent
- Reduced from 457 lines to 232 lines (49% reduction)
- Added skill references: phase-rules, commit-discipline, verification-layers
- Removed inline phase rules (POC/Refactor/Testing/Quality/PR Lifecycle details)
- Removed inline commit discipline details (locking, spec file rules)
- Kept essential orchestration: execution flow, forbidden tools, output formats
- Kept [VERIFY] task delegation rules (essential to agent's identity)

### Task 2.18: Simplify design.md, requirements.md, tasks.md
- design.md: 301 -> 86 lines (71% reduction)
- requirements.md: 294 -> 85 lines (71% reduction)
- tasks.md: 314 -> 94 lines (70% reduction)
- All three use <skill-reference> blocks to reference interview-framework skill
- Kept command-specific question pools inline (4 questions each)
- Core orchestration: spec detection, validation, context gathering, delegation, review loop, state update

### Verification: 2.19 [VERIFY] Quality checkpoint: command simplification
- Status: PASS
- All major commands under target line counts:
  - implement.md: 233 lines (target: <300) - PASS
  - start.md: 248 lines (target: <350) - PASS
  - research.md: 200 lines (target: <250) - PASS
- No fixes needed

### Task 2.17: Simplify research.md
- Reduced from 713 lines to 200 lines (72% reduction)
- Used <skill-reference> blocks to reference: interview-framework, parallel-research
- Kept core orchestration: spec detection, validation, merge structure, review loop, state update
- Interview questions kept inline (4 questions, command-specific)
- Merge template kept inline as it's specific to research output structure

### Task 2.16: Simplify start.md
- Reduced from 980 lines to 248 lines (75% reduction)
- Used <skill-reference> blocks to reference: branch-management, intent-classification, spec-scanner
- Kept core orchestration logic: argument parsing, detection logic, resume/new flows, quick mode
- Interview question pool kept inline (4 questions, command-specific)
- Quick mode flow kept inline as it's specific to this command

### Task 2.15: Simplify implement.md
- Reduced from 1235 lines to 233 lines (81% reduction)
- Used <skill-reference> blocks to reference: coordinator-pattern, failure-recovery, verification-layers
- Kept core orchestration logic: Ralph Loop dependency check, prerequisites, state initialization, Ralph Loop invocation
- Coordinator prompt now delegates to skills for detailed procedures
- PR Lifecycle Loop kept inline as it's specific to this command's flow

### Verification: 2.14 [VERIFY] Quality checkpoint: new skills batch 3
- Status: PASS
- Verified: 4/4 skills exist with version field
- Skills checked: phase-rules (v0.1.0), commit-discipline (v0.1.0), quality-checkpoints (v0.1.0), quality-commands (v0.1.0)
- All files at: plugins/ralph-specum/skills/{skill-name}/SKILL.md
- No fixes needed

### Verification: 2.9 [VERIFY] Quality checkpoint: new skills batch 2
- Status: PASS
- Verified: 4/4 skills exist with version field
- Skills checked: branch-management (v0.1.0), intent-classification (v0.1.0), spec-scanner (v0.1.0), parallel-research (v0.1.0)
- All files at: plugins/ralph-specum/skills/{skill-name}/SKILL.md
- No fixes needed

### Verification: 2.4 [VERIFY] Quality checkpoint: new skills batch 1
- Status: PASS
- Verified: 3/3 skills exist with version field
- Skills checked: failure-recovery (v0.1.0), verification-layers (v0.1.0), coordinator-pattern (v0.1.0)
- All files at: plugins/ralph-specum/skills/{skill-name}/SKILL.md
- No fixes needed

### Verification: 1.14 [VERIFY] Phase A complete validation
- Status: PASS
- Script: `bash scripts/validate-plugins.sh && echo "Phase A PASS"`
- Exit code: 0
- Results:
  - 14/14 agents have color field
  - 14/14 agents have 2+ example blocks
  - 10/10 skills have version field
  - 2/2 hooks.json files have matcher field
  - 0 legacy commands directories found
- No fixes needed

### Verification: 1.11 [VERIFY] Quality checkpoint: commands
- Status: PASS
- Verified: 13/13 commands have `name:` field
- Verified: Legacy directory `plugins/ralph-speckit/.claude/commands/` does NOT exist
- Commands checked: analyze.md, cancel.md, checklist.md, clarify.md, constitution.md, implement.md, plan.md, specify.md, start.md, status.md, switch.md, tasks.md, taskstoissues.md
- No fixes needed

### Verification: 1.7 [VERIFY] Quality checkpoint: skills and hooks
- Status: PASS
- Verified: 10/10 skills have `version:` field
- Verified: 2/2 hooks.json files have `"matcher"` field
- Plugins checked: ralph-specum (6 skills, 1 hooks.json), ralph-speckit (4 skills, 1 hooks.json)
- No fixes needed

### Verification: 1.3 [VERIFY] Quality checkpoint: agent metadata
- Status: PASS
- Verified: 14/14 agents have `color:` field and 2+ `<example>` blocks
- Plugins checked: ralph-specum (8 agents), ralph-speckit (6 agents)
- No fixes needed

- Agents require `color` field (blue, cyan, green, yellow, magenta, red) - this was missing in all agents
- Agent descriptions must include `<example>` blocks with Context/user/assistant/commentary format for proper triggering
- Hook entries require `matcher` field even when applying to all events (use `"*"`)
- Plugin hooks.json format requires outer wrapper: `{"description": "...", "hooks": {...}}`
- Skills require `version` field in frontmatter and third-person description with trigger phrases
- ralph-speckit has legacy command structure in `.claude/commands/` that should be consolidated to `commands/`
- Requirements phase: 5 user stories created covering agents, skills, hooks, commands, and validation
- Requirements phase: 10 functional requirements prioritized P0-P2 (P0=critical, P1=high, P2=nice-to-have)
- Requirements phase: Color grouping by function recommended (analysis=blue/cyan, execution=green, validation=yellow, transformation=magenta)
- Requirements phase: Backward compatibility is critical NFR - zero breaking changes to existing workflows
- Design phase: 36 files total need changes (32 edits, 9 creates, 9 deletes)
- Design phase: Color assignments finalized - blue/cyan for analysis, green for execution, yellow for validation, magenta for transformation
- Design phase: Legacy command migration requires stripping "speckit." prefix for consistency with modern commands
- Design phase: Validation script in bash checks 5 compliance areas (color, examples, version, matcher, legacy dir)
- Design phase: Git provides complete rollback strategy - no destructive external state changes
- Design update: Commands are currently 100-1200 lines - implement.md is 1200+ lines alone
- Design update: Consolidation can extract ~1500 lines from commands/agents into 11 new skills
- Design update: implement.md can be reduced from 1200 to ~150 lines by referencing skills
- Design update: Skill reference pattern uses `<skill-reference>` or inline `**Apply skill**: path` format
- Design update: Phase B adds 11 new skills: failure-recovery, verification-layers, coordinator-pattern, branch-management, intent-classification, spec-scanner, parallel-research, phase-rules, commit-discipline, quality-checkpoints, quality-commands
- Design update: Commands become thin orchestrators (~80-200 lines) that reference skills for heavy-lifting
- Design update: Phase A (metadata) can be deployed independently before Phase B (consolidation)

## Next

Task 2.23 [VERIFY] Quality checkpoint: agent simplification

## Blockers

(none)

## Task Planning Notes

- Tasks grouped to reduce count: 8 ralph-specum agents = 1 task, 6 ralph-speckit agents = 1 task
- Total: 32 tasks (14 Phase A, 14 Phase B, 1 Phase 3, 3 Phase 4/5)
- Quality checkpoints every 2-3 tasks as required
- Phase A can be deployed independently (metadata fixes only)
- Phase B has dependency: skills must be created before commands/agents simplified
- Verification commands use bash loops to validate multiple files atomically
