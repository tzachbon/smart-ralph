# Progress: reviewer-subagent

## Original Goal

Introduce a reviewer sub-agent concept for the Ralph Specum plugin. The reviewer is a sub-agent that:

1. **Phase Reviews**: After each spec phase (research, requirements, design, tasks) completes, a reviewer sub-agent reviews the output before presenting it to the user. It validates assumptions, ensures grounding, checks adherence to practices, and iterates with the orchestrator until the output meets quality standards.

2. **Execution Reviews**: During task execution, after each task (or group of tasks), the reviewer checks the implementation for hallucinations, correctness, and alignment with specs. If issues are found, the reviewer can:
   - Add new tasks to fix problems
   - Update spec files themselves
   - Iterate with the orchestrator until quality is met

3. **Iteration Loop**: The reviewer iterates with the phase agent/orchestrator until it approves the output with "Looks good, we can continue."

This applies to all phases: research, requirements, design, tasks, and execution.

## Interview Format
- Version: 1.0

## Intent Classification
- Type: GREENFIELD
- Confidence: high (3 keywords matched)
- Min questions: 5
- Max questions: 10
- Keywords matched: introduce, new, concept

## Completed Tasks
- [x] 1.1 Create spec-reviewer.md agent definition
- [x] 1.2 Add review loop to research.md command (POC integration)
- [x] 1.3 [VERIFY] POC checkpoint - reviewer agent and research integration
- [x] 2.1 Add review loop to requirements.md command
- [x] 2.2 Add review loop to design.md command
- [x] 2.3 Add review loop to tasks.md command
- [x] 2.4 [VERIFY] Phase commands integration checkpoint
- [x] 2.5 Add execution review to implement.md coordinator
- [x] 2.6 Add review step to plan-synthesizer.md for quick mode

## Current Task
Awaiting next task



## Learnings
- Synthesis: Plugin uses markdown-only agents with no build step. All changes are markdown files.
- Synthesis: Review insertion point is between phase agent completion and awaitingApproval flag. This is the natural seam in every phase command.
- Synthesis: Subagents cannot spawn other subagents - reviewer MUST be invoked by coordinator (command level), not by phase agent.
- Synthesis: Existing qa-engineer handles command-based verification (VERIFICATION_PASS/FAIL). Reviewer handles conceptual quality review (REVIEW_PASS/FAIL). These are distinct and complementary.
- Synthesis: Stop-hook is Haiku-based (prompt type) and cannot read files. Review logic must live in commands, not hooks.
- Synthesis: Quick mode (plan-synthesizer) currently has no review step. This is where automated review adds most value since there's no human-in-the-loop.
- Synthesis: Max 3 review iterations based on research showing quality plateaus after 2-3 iterations. Graceful degradation prevents blocking.
- Pattern: All phase commands follow identical structure: Validate -> Interview -> Execute -> Walkthrough -> Review -> Update State -> Commit -> Stop
- Pattern: Agent frontmatter must include name, description (with trigger phrases), model: inherit
- Pattern: Version bumps required in BOTH plugin.json AND marketplace.json (currently 3.4.0)
- Agent file convention: frontmatter (name, description with trigger phrases, model: inherit) + Core Philosophy mandatory block + When Invoked + Execution Flow + domain-specific sections + Output Format mandatory block + Communication Style mandatory block
- Execution review in implement.md uses Layer 5 in verification layers, adapted from phase review pattern. Key difference: on REVIEW_FAIL, coordinator can add fix tasks (same as Section 6c) rather than re-invoking a phase agent.
- Plan-synthesizer review differs from phase commands: plan-synthesizer IS the author, so it revises artifacts directly on REVIEW_FAIL (no need to re-invoke a separate phase agent)

### Verification: 1.3 [VERIFY] POC checkpoint - reviewer agent and research integration
- Status: PASS
- Commands:
  - grep -q "name: spec-reviewer" agents/spec-reviewer.md: PASS (exit 0)
  - grep -q "model: inherit" agents/spec-reviewer.md: PASS (exit 0)
  - grep -q "Artifact Review" commands/research.md: PASS (exit 0)
  - grep -q "iteration" commands/research.md: PASS (exit 0)
- Convention checks:
  - spec-reviewer.md frontmatter matches existing agent convention (name, description with trigger phrases, model: inherit): PASS
  - research.md review loop has required structure (iteration counter, max 3, REVIEW_PASS/FAIL signal parsing, graceful degradation): PASS
  - Review delegation prompt uses subagent_type: spec-reviewer with proper artifact content and iteration tracking: PASS

### Verification: 2.4 [VERIFY] Phase commands integration checkpoint
- Status: PASS
- Primary check (Artifact Review + spec-reviewer in all 4 commands): PASS (exit 0, no FAIL output)
- REVIEW_PASS handling:
  - research.md: PASS (5 occurrences)
  - requirements.md: PASS (5 occurrences)
  - design.md: PASS (5 occurrences)
  - tasks.md: PASS (5 occurrences)
- REVIEW_FAIL handling:
  - research.md: PASS (6 occurrences)
  - requirements.md: PASS (6 occurrences)
  - design.md: PASS (6 occurrences)
  - tasks.md: PASS (6 occurrences)
- Iteration limit (max 3): PASS in all 4 commands
- Quick mode skip: PASS in all 4 commands
- Pattern consistency: All 4 commands have identical signal counts (REVIEW_PASS=5, REVIEW_FAIL=6)
- Section heading: All 4 commands have "## Artifact Review" section

## Next
Task 2.7 Add review logging to .progress.md
