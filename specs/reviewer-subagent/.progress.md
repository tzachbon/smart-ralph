# Progress: reviewer-subagent

## Original Goal

Introduce a reviewer sub-agent concept for the Ralph Specum plugin. The reviewer is a sub-agent that:

1. **Phase Reviews**: After each spec phase (research, requirements, design, tasks) completes, a reviewer sub-agent reviews the output before presenting it to the user. It validates assumptions, ensures grounding, checks adherence to practices, and iterates with the orchestrator until the output meets quality standards.

2. **Execution Reviews**: During task execution, after each task (or group of tasks), the reviewer checks the implementation for hallucinations, correctness, and alignment with specs. If issues are found, the reviewer can:
   - Add new tasks to fix problems
   - Update spec files themselves
   - Iterate with the orchestrator until quality is met

3. **Iteration Loop**: The reviewer iterates with the phase agent/orchestrator until it approves the output with "Looks good, we can continue."

This applies to all phases: research, requirements, design, tasks, and execution.

## Interview Format
- Version: 1.0

## Intent Classification
- Type: GREENFIELD
- Confidence: high (3 keywords matched)
- Min questions: 5
- Max questions: 10
- Keywords matched: introduce, new, concept

## Completed Tasks
- [x] 1.1 Create spec-reviewer.md agent definition
- [x] 1.2 Add review loop to research.md command (POC integration)
- [x] 1.3 [VERIFY] POC checkpoint - reviewer agent and research integration
- [x] 2.1 Add review loop to requirements.md command
- [x] 2.2 Add review loop to design.md command
- [x] 2.3 Add review loop to tasks.md command
- [x] 2.4 [VERIFY] Phase commands integration checkpoint
- [x] 2.5 Add execution review to implement.md coordinator
- [x] 2.6 Add review step to plan-synthesizer.md for quick mode
- [x] 2.7 Add review logging to .progress.md
- [x] 2.8 [VERIFY] Full integration checkpoint
- [x] 3.1 Bump version in plugin.json
- [x] 3.2 Bump version in marketplace.json
- [x] 3.3 Review and refine spec-reviewer rubrics
- [x] 3.4 Ensure error handling in all review loops
- [x] 3.5 [VERIFY] Refinement checkpoint
- [x] 4.1 [VERIFY] Full pattern consistency check
- [x] 4.2 [VERIFY] AC checklist verification
- [x] 5.1 Create PR and verify CI

## Current Task
ALL TASKS COMPLETE





## Learnings
- Synthesis: Plugin uses markdown-only agents with no build step. All changes are markdown files.
- Synthesis: Review insertion point is between phase agent completion and awaitingApproval flag. This is the natural seam in every phase command.
- Synthesis: Subagents cannot spawn other subagents - reviewer MUST be invoked by coordinator (command level), not by phase agent.
- Synthesis: Existing qa-engineer handles command-based verification (VERIFICATION_PASS/FAIL). Reviewer handles conceptual quality review (REVIEW_PASS/FAIL). These are distinct and complementary.
- Synthesis: Stop-hook is Haiku-based (prompt type) and cannot read files. Review logic must live in commands, not hooks.
- Synthesis: Quick mode (plan-synthesizer) currently has no review step. This is where automated review adds most value since there's no human-in-the-loop.
- Synthesis: Max 3 review iterations based on research showing quality plateaus after 2-3 iterations. Graceful degradation prevents blocking.
- Pattern: All phase commands follow identical structure: Validate -> Interview -> Execute -> Walkthrough -> Review -> Update State -> Commit -> Stop
- Pattern: Agent frontmatter must include name, description (with trigger phrases), model: inherit
- Pattern: Version bumps required in BOTH plugin.json AND marketplace.json (currently 3.4.0)
- Agent file convention: frontmatter (name, description with trigger phrases, model: inherit) + Core Philosophy mandatory block + When Invoked + Execution Flow + domain-specific sections + Output Format mandatory block + Communication Style mandatory block
- Execution review in implement.md uses Layer 5 in verification layers, adapted from phase review pattern. Key difference: on REVIEW_FAIL, coordinator can add fix tasks (same as Section 6c) rather than re-invoking a phase agent.
- Plan-synthesizer review differs from phase commands: plan-synthesizer IS the author, so it revises artifacts directly on REVIEW_FAIL (no need to re-invoke a separate phase agent)
- Review iteration logging follows consistent pattern across all 5 commands: "### Review: $artifactType (Iteration $N)" with Status/Findings/Action fields. Implement.md uses "execution (Task $taskIndex, Iteration $N)" to include task context.
- Rubric refinement: Added concrete PASS/FAIL examples after each rubric table. Execution rubric now explicitly cross-references design.md Components section. Edge cases expanded to cover frontmatter-only artifacts and missing iteration numbers.

### Verification: 1.3 [VERIFY] POC checkpoint - reviewer agent and research integration
- Status: PASS
- Commands:
  - grep -q "name: spec-reviewer" agents/spec-reviewer.md: PASS (exit 0)
  - grep -q "model: inherit" agents/spec-reviewer.md: PASS (exit 0)
  - grep -q "Artifact Review" commands/research.md: PASS (exit 0)
  - grep -q "iteration" commands/research.md: PASS (exit 0)
- Convention checks:
  - spec-reviewer.md frontmatter matches existing agent convention (name, description with trigger phrases, model: inherit): PASS
  - research.md review loop has required structure (iteration counter, max 3, REVIEW_PASS/FAIL signal parsing, graceful degradation): PASS
  - Review delegation prompt uses subagent_type: spec-reviewer with proper artifact content and iteration tracking: PASS

### Verification: 2.4 [VERIFY] Phase commands integration checkpoint
- Status: PASS
- Primary check (Artifact Review + spec-reviewer in all 4 commands): PASS (exit 0, no FAIL output)
- REVIEW_PASS handling:
  - research.md: PASS (5 occurrences)
  - requirements.md: PASS (5 occurrences)
  - design.md: PASS (5 occurrences)
  - tasks.md: PASS (5 occurrences)
- REVIEW_FAIL handling:
  - research.md: PASS (6 occurrences)
  - requirements.md: PASS (6 occurrences)
  - design.md: PASS (6 occurrences)
  - tasks.md: PASS (6 occurrences)
- Iteration limit (max 3): PASS in all 4 commands
- Quick mode skip: PASS in all 4 commands
- Pattern consistency: All 4 commands have identical signal counts (REVIEW_PASS=5, REVIEW_FAIL=6)
- Section heading: All 4 commands have "## Artifact Review" section

### Verification: 2.8 [VERIFY] Full integration checkpoint
- Status: PASS
- Core checks:
  - spec-reviewer.md agent exists: PASS
  - research.md has Artifact Review: PASS
  - requirements.md has Artifact Review: PASS
  - design.md has Artifact Review: PASS
  - tasks.md has Artifact Review: PASS
  - implement.md has Layer 5: PASS
  - plan-synthesizer has spec-reviewer: PASS
- Review Iteration Logging in all 5 commands: PASS (research, requirements, design, tasks, implement)
- REVIEW_PASS/REVIEW_FAIL signals:
  - research.md: REVIEW_PASS=9, REVIEW_FAIL=10: PASS
  - requirements.md: REVIEW_PASS=9, REVIEW_FAIL=10: PASS
  - design.md: REVIEW_PASS=9, REVIEW_FAIL=10: PASS
  - tasks.md: REVIEW_PASS=9, REVIEW_FAIL=10: PASS
  - implement.md: REVIEW_PASS=9, REVIEW_FAIL=10: PASS
  - plan-synthesizer.md: REVIEW_PASS=3, REVIEW_FAIL=5: PASS
- Iteration limits (max 3) referenced in all 5 commands: PASS
- Quick mode skip in all 4 phase commands: PASS

### Verification: 3.5 [VERIFY] Refinement checkpoint
- Status: PASS
- Check 1 (version + error handling base): grep -q '"3.5.0"' plugin.json && marketplace.json && grep -q "treat as REVIEW_PASS" research.md: PASS (exit 0)
- Check 2 (rubric refinement): grep -c "PASS" spec-reviewer.md = 35 (threshold >= 5): PASS
- Check 3 (error handling consistency across all 5 commands):
  - research.md: OK
  - requirements.md: OK
  - design.md: OK
  - tasks.md: OK
  - implement.md: OK

### Verification: 4.1 [VERIFY] Full pattern consistency check
- Status: PASS
- Frontmatter checks (name, description, model: inherit): PASS
- REVIEW_PASS counts across 4 phase commands: 10/10/10/10 (consistent)
- REVIEW_FAIL counts across 4 phase commands: 10/10/10/10 (consistent)
- Artifact Review section in all 4 commands: PASS
- spec-reviewer delegation in all 4 commands: PASS
- Quick mode skip in all 4 commands: PASS
- Max 3 iteration limit in all 4 commands: PASS
- Error handling (treat as REVIEW_PASS) in all 4 commands: PASS
- Graceful degradation (Review Warning) in all 4 commands: PASS
- Mandatory tags in spec-reviewer.md: 4 (Core Philosophy, Iteration Awareness, Output Format, Communication Style)

### Verification: 4.2 [VERIFY] AC checklist verification
- Status: PASS
- AC-1.1: research.md delegates to spec-reviewer before awaitingApproval: PASS
- AC-1.2: requirements.md delegates to spec-reviewer before awaitingApproval: PASS
- AC-1.3: design.md delegates to spec-reviewer before awaitingApproval: PASS
- AC-1.4: tasks.md delegates to spec-reviewer before awaitingApproval: PASS
- AC-1.5: REVIEW_PASS/REVIEW_FAIL signals in spec-reviewer.md (14 occurrences): PASS
- AC-1.6: Revision Delegation Prompt present in all 4 phase commands: PASS
- AC-1.7: iteration <= 3 enforced in all 4 phase commands: PASS
- AC-2.1: implement.md has spec-reviewer delegation after TASK_COMPLETE: PASS
- AC-2.2: implement.md cross-references design.md and requirements.md: PASS
- AC-2.3: implement.md has fix task generation on REVIEW_FAIL: PASS
- AC-2.4: implement.md has Review Suggestions for spec updates: PASS
- AC-2.5: reviewIteration <= 3 in implement.md: PASS
- AC-3.1: Max 3 iterations enforced in all commands: PASS
- AC-3.2: Graceful degradation with Review Warning in all commands: PASS
- AC-3.3: REVIEW_PASS convergence signal: PASS
- AC-3.4: Review Iteration Logging in implement.md: PASS
- AC-4.1: plan-synthesizer invokes spec-reviewer: PASS
- AC-4.2: plan-synthesizer reviews all 4 artifacts in sequence: PASS
- AC-4.3: iteration <= 3 in plan-synthesizer: PASS
- AC-4.4: plan-synthesizer uses same rubric pattern: PASS
- AC-5.1: spec-reviewer.md exists with correct frontmatter: PASS
- AC-5.2: 5 type-specific rubrics (research, requirements, design, tasks, execution): PASS
- AC-5.3: REVIEW_PASS/REVIEW_FAIL signal pattern: PASS
- AC-5.4: Read-only via Task delegation (NEVER modify files): PASS
- AC-5.5: plugin.json and marketplace.json both at 3.5.0: PASS
- All 24 ACs verified: PASS

## Next
ALL TASKS COMPLETE - PR: https://github.com/tzachbon/smart-ralph/pull/92
