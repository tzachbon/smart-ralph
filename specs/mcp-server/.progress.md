# Progress: mcp-server

## Original Goal

Convert ralph-specum plugin to an MCP server for broader tool compatibility and standalone usage outside Claude Code

## Interview Format
- Version: 1.0

## Intent Classification
- Type: GREENFIELD
- Confidence: medium (2 keywords matched)
- Min questions: 5
- Max questions: 10
- Keywords matched: convert, usage

## Interview Responses

### Goal Interview (from start.md)
- Problem: Enable use outside Claude Code - allow ralph-specum workflows in other AI tools (Cursor, Continue, etc.)
- Constraints: Must maintain plugin compatibility, be an executable, prefer created with Bun, need to learn how to generate such MCP server
- Success criteria: Works in external MCP-compatible tools AND has feature parity with existing plugin
- Additional context: None - proceeding with research

### Requirements Interview (from requirements.md)
- Primary users: End users via MCP clients (external users installing in Cursor, Continue, etc.)
- Priority tradeoffs: Prioritize speed of delivery (MVP out fast, iterate later)
- Success criteria: All of the above - full feature parity, works in major clients, easy installation
- Additional requirements context: None

### Requirements Review (from requirements.md)
- User stories approval: Added US-14 (npx) and US-15 (logging) per feedback
- Acceptance criteria approval: Clear and testable
- Priorities approval: Yes, appropriate
- Requirements feedback: Approved

### Design Interview (from design.md)
- Architecture style: Extend existing architecture - follow patterns from ralph-specum plugin, adapt for MCP protocol
- Technology constraints: Use the most common best-practice options, no custom stuff
- Integration approach: Use existing APIs and interfaces - leverage existing file formats (.ralph-state.json, spec files)
- Additional design context: None - proceeding with design

### Design Review (from design.md)
- Architecture approval: Looks good, also need to update this repo to use Bun and set it up with corepack
- Technical decisions approval: Yes, approved
- Component structure approval: Yes, clear
- Design feedback: Approved

### Tasks Interview (from tasks.md)
- Testing depth: Standard - unit + integration
- Deployment approach: Standard CI/CD pipeline
- Execution priority: Balanced - reasonable quality with speed
- Additional execution context: None - proceeding with tasks

### Tasks Review (from tasks.md)
- Task coverage: Yes, comprehensive
- Task phases: Yes, good structure
- Verification steps: Yes, clear
- Tasks feedback: Approved

## Status

- Phase: tasks
- Started: 2026-01-26

## Completed Tasks

- [x] 1.1 Initialize repository with Bun and corepack
- [x] 1.2 Initialize mcp-server directory structure
- [x] 1.3 Copy agent prompts to MCP server assets
- [x] 1.4 Copy templates to MCP server assets
- [x] 1.5 Create assets barrel with Bun text imports
- [x] 1.6 [VERIFY] Quality checkpoint: typecheck
- [x] 1.7 Implement MCPLogger
- [x] 1.8 Implement StateManager
- [x] 1.9 Implement FileManager
- [x] 1.10 [VERIFY] Quality checkpoint: typecheck
- [x] 1.11 Implement direct tools: status, help
- [x] 1.12 Implement direct tools: switch, cancel
- [x] 1.13 Implement ralph_start tool
- [x] 1.14 [VERIFY] Quality checkpoint: typecheck
- [x] 1.15 Implement ralph_complete_phase tool

## Learnings

### Requirements Phase
- Added `ralph_complete_phase` tool for explicit state transitions (research found implicit detection risky)
- Excluded refactor command from MVP - not critical for core workflow
- Interview questions skipped in MCP - goal from tool input is sufficient
- 11 total tools (10 original + complete_phase) - manageable scope
- Instruction-return pattern applies to 5 tools, direct implementation for 6
- Quick mode prioritized (P1) - important for non-interactive workflows

### MCP Protocol
- MCP protocol uses JSON-RPC 2.0 over stdio (local) or Streamable HTTP (remote)
- Latest spec (2025-11-25) adds parallel tool calls and server-side agent loops
- Bun MCP servers must NEVER use console.log() - corrupts JSON-RPC messages
- Official SDK: @modelcontextprotocol/sdk with Zod peer dependency (v3.25+)
- SSE transport is deprecated - use Streamable HTTP or stdio only

### Architecture Decision: Standalone Compiled Binary
- **User requirement**: Must be standalone executable, not require bunx/npx
- **Solution**: `bun build --compile` creates single binary with Bun runtime embedded
- **No runtime dependency**: Users don't need Bun/Node installed

### Distribution (3 methods)
1. **Install script** (recommended): `curl -fsSL .../install.sh | bash`
   - Auto-detects OS/arch, downloads correct binary, installs to /usr/local/bin
2. **npm package**: `npm install -g @smart-ralph/ralph-specum-mcp` or `npx @smart-ralph/ralph-specum-mcp`
   - Scoped under @smart-ralph org
   - Requires Bun runtime
3. **GitHub releases**: Manual download of platform-specific binaries
   - macOS (arm64 + x64), Linux (x64), Windows (x64)

### Standalone MCP Server (Not Plugin Wrapper)
- MCP server is **self-contained** - works independently of Claude Code plugin
- Agent prompts, templates, logic **embedded in binary** at compile time
- Direct file I/O for spec operations (no plugin required)
- Git operations via shell out to `git` CLI
- Same .ralph-state.json format for compatibility if plugin is also used

### Tool Implementation Pattern
- **Instruction-return pattern** for complex tools (research, requirements, design, tasks)
  - MCP server returns structured instructions + embedded agent prompt
  - LLM client (Claude Desktop, Cursor, etc.) executes the workflow
  - Server doesn't need Task tool - leverages client's capabilities
- **Direct implementation** for simple tools (status, switch, cancel, help)
  - Execute immediately, return results

### Client Configuration
- Client config uses command path to compiled binary:
  ```json
  {
    "mcpServers": {
      "ralph-specum": {
        "command": "/path/to/ralph-specum-mcp"
      }
    }
  }
  ```

### Related Specs
- ralph-speckit, implement-ralph-wiggum are independent, no updates needed

### Requirements Update (2026-01-26)
- Added US-14: npx usage for npm distribution
- npx path requires Bun runtime (unlike compiled binary)
- MCP client config for npx: `{ "command": "npx", "args": ["@smart-ralph/ralph-specum-mcp"] }`
- FR-10 (npm distribution) now has full user story coverage

### Requirements Update #2 (2026-01-26) - MCP Logging
- Added US-15: MCP Standard Logging with 6 acceptance criteria
- Added FR-12: MCP standard logging via `logging/message` notifications (P0)
- Added NFR-7: Logging compliance with MCP spec
- MCP logging uses `logging/message` notifications, NOT console.log
- All logs must go to stderr only - stdout corrupts JSON-RPC transport
- Structured JSON format: `{ level, logger, data, timestamp }`
- Removed "MCP server logging/telemetry" from Out of Scope (now in scope)
- Clarified Resources and Prompts deferred to v2 with rationale (considered for spec files and workflow templates)

## Blockers

(none)

## Next

Task 1.16: Implement instruction tools (research, requirements, design, tasks)

## Learnings

### Task Planning Phase (2026-01-26)
- 46 total tasks across 5 phases
- Phase 1 (POC): 22 tasks - focus on getting end-to-end working
- Phase 2 (Refactoring): 6 tasks - code cleanup and error handling
- Phase 3 (Testing): 8 tasks - unit and integration tests
- Phase 4 (Quality Gates): 4 tasks - CI/CD setup and PR creation
- Phase 5 (PR Lifecycle): 4 tasks - continuous validation loop
- First task (1.1) addresses user feedback: initialize repo with Bun and corepack
- Quality checkpoints inserted after every 2-3 tasks for early issue detection
- POC validation (task 1.22) uses real Claude Desktop testing to verify end-to-end
- Build/install scripts created in Phase 4 rather than POC to focus on core functionality first
- Integration tests test full workflow: start -> research -> requirements -> design -> tasks
- No VF task needed - this is GREENFIELD, not a fix-type goal

### Design Phase (2026-01-26)
- 11 tools total: 6 direct (start, status, switch, cancel, complete_phase, help) + 5 instruction-return (research, requirements, design, tasks, implement)
- Instruction-return pattern: Server returns embedded agent prompt + context, LLM client executes the workflow
- Bun `import with { type: "text" }` embeds markdown files at compile time - no runtime file reads needed
- StateManager must validate JSON schema on read to handle corruption gracefully
- FileManager operations assume single-client access (no file locking needed for stdio transport)
- MCPLogger writes to stderr only - stdout reserved for JSON-RPC protocol
- Same RalphState interface as plugin for compatibility
- Build script targets 4 platforms: darwin-arm64, darwin-x64, linux-x64, windows-x64
- Install script auto-detects OS/arch from uname output
- npm package uses `"bin"` field pointing to TypeScript entry for Bun execution
- Tool schemas use Zod for type inference and SDK compatibility

### Task 1.2 Learnings (2026-01-26)
- npmmirror.com works as alternate npm registry when registry.npmjs.org is blocked by corporate network
- Add project-level .npmrc to override global corporate registry settings
- Bun install with npmmirror: `registry=https://registry.npmmirror.com/` in .npmrc

### Verification: 1.6 [VERIFY] Quality checkpoint: typecheck (2026-01-26)
- Status: PASS (after fix)
- Issue found: TypeScript could not resolve `.md` file imports with Bun's `{ type: "text" }` attribute
- Fix applied: Created `/Users/zachbonfil/projects/smart-ralph-mcp-server/mcp-server/src/md.d.ts` with module declaration for `*.md` files
- Command: `bun run typecheck` (exit 0 after fix)
- Duration: ~30s

### Verification: 1.10 [VERIFY] Quality checkpoint: typecheck (2026-01-26)
- Status: PASS
- Command: `bun run typecheck` (exit 0)
- Result: No type errors - all lib modules (logger.ts, state.ts, files.ts) compile correctly
- Duration: ~5s

### Verification: 1.14 [VERIFY] Quality checkpoint: typecheck (2026-01-26)
- Status: PASS
- Command: `bun run typecheck` (exit 0)
- Result: No type errors - all direct tools (status.ts, help.ts, switch.ts, cancel.ts, start.ts) compile correctly
- Duration: ~2s
