---
spec: fork-ralph-wiggum
created: 2026-02-14
---

# Progress: fork-ralph-wiggum

## Original Goal
In the past we removed the Ralph Wiggum plug-in and we tried to do it on our own but it's totally failing because it does not actually re-invoke Claude when it stops and it's a core problem. The idea is that we do not want to introduce the Ralph Wiggum plug-in as a dependency again. We want to fork Ralph Wiggum, extract all the relevant files, and use them directly in this repo.

## Interview Format
- Version: 1.0

## Intent Classification
- Type: GREENFIELD
- Confidence: high (4 keywords matched)
- Min questions: 5
- Max questions: 10
- Keywords matched: fork, extract, introduce, build

## Related Specs
- implement-ralph-wiggum [High]: Made /implement command run original Ralph Wiggum plugin
- remove-ralph-wiggum [High]: Removed ralph-loop dependency for self-contained execution (v3.0.0)
- return-ralph-wrigum [Medium]: Recently created, empty

## Codebase Research (Auto-gathered)

### Core Problem
The self-contained stop-hook approach (v3.0.0) fails because Stop hooks are one-way output only. They run AFTER Claude finishes responding and output text, but that text is NOT fed back into Claude's processing pipeline. The stop-watcher.sh was essentially outputting prompts to /dev/null architecturally.

### What Ralph Wiggum Does Differently
- Uses `/ralph-loop` command with explicit iteration support
- Can block Claude's exit (exit code 2) and re-inject prompts
- Handles the loop at the command/plugin level, not at the hook level
- Uses Claude Code's native capabilities for session continuation

### Key Files Involved
- `plugins/ralph-specum/commands/implement.md` - coordinator prompt
- `plugins/ralph-specum/hooks/scripts/stop-watcher.sh` - stop hook (currently just logging/cleanup)
- `plugins/ralph-specum/hooks/hooks.json` - hook registration
- `.ralph-state.json` - execution state

## Interview Responses

### Goal Interview (from start.md)
- Problem: Both - need the loop to work AND want it owned in this repo (no external dependency)
- Constraints: Selective extraction - cherry-pick specific components (loop command, stop hook integration, etc.)
- Success criteria: Loop works end-to-end, no external deps, and existing bats tests still pass
- Location: Shared lib directory - create plugins/ralph-specum/lib/ for the forked loop mechanism
- Source: Ralph Wiggum is a public package on npm/GitHub, can examine during research
- Additional context: None, proceed with research

### Requirements Interview (from requirements.md)
- Primary users: Both developers and end users (plugin developers AND marketplace consumers)
- Priority tradeoffs: Prioritize speed of delivery - get the loop working ASAP with minimal changes
- Success criteria: Feature works as specified - loop correctly re-invokes Claude, executes tasks sequentially until ALL_TASKS_COMPLETE

### Design Interview (from design.md)
- Architecture style: Extend existing architecture - modify stop-watcher.sh in-place, keep all existing logic, just change output format
- Technology constraints: No constraints - keep using jq for JSON output, same dependencies
- Guard logic: Stop hook should ONLY be active during execution phase (implement). During research, design, and task phases it should NOT block Claude from stopping. Small caveat for quick mode.

### Tasks Interview (from tasks.md)
- Testing depth: Standard - unit + integration (update existing bats tests, add new guard tests)
- Execution priority: Balanced - reasonable quality with speed

## Completed Tasks
- [x] 1.1 Add JSON assertion helpers to test setup
- [x] 1.2 Parameterize hook input helpers with stop_hook_active
- [x] 1.3 Convert corrupt state error to JSON output
- [x] 1.4 Convert max iterations error to JSON output
- [x] 1.5 [VERIFY] Quality checkpoint: all 58 tests pass
- [x] 1.6 Add stop_hook_active guard and convert continuation prompt to JSON
- [x] 1.7 POC Checkpoint: all 4 manual tests pass, all 58 bats tests pass
- [x] 2.1 Remove ralph-wiggum from settings and bump version
- [x] 3.1 Update stop-hook.bats continuation assertions to JSON
- [x] 3.2 Update stop-hook.bats error assertions to JSON
- [x] 3.3 [VERIFY] Quality checkpoint: fixed stderr-in-output issue, all 24 stop-hook tests pass
- [x] 3.4 Add new stop_hook_active guard tests

## Current Task
Awaiting next task

## Learnings
- The stop-watcher.sh failure is NOT architectural -- it's a JSON output format issue. Plain text stdout on exit 0 is only shown in verbose mode for Stop hooks. The fix is to output `{"decision":"block","reason":"..."}` JSON.
- Ralph Wiggum's `/ralph-loop` command is just a wrapper that creates a state file. The actual loop mechanism is entirely in the Stop hook's JSON output format -- identical hook type to what we already have.
- No need to create `lib/` directory or fork files. The existing stop-watcher.sh already has all the logic (state reading, transcript detection, path resolution). Only the output format needs changing.
- Historical plugin hook bugs (#10412, #10875) where plugin stdout wasn't captured are now CLOSED/FIXED. The official Ralph Wiggum plugin works via the same mechanism.
- `stop_hook_active` field in hook input (boolean) indicates whether Claude is already in a continuation loop -- should be checked to prevent infinite rapid re-invocation.
- `.claude/settings.json` currently has BOTH `ralph-wiggum@claude-plugins-official` AND `ralph-specum@smart-ralph` enabled, which means two competing Stop hooks fire. Must remove ralph-wiggum to avoid conflicts.
- Existing bats tests (18 tests in stop-hook.bats) will need updating from plain text assertions to JSON assertions.
- Requirements: Error cases (corrupt state, max iterations) should also output JSON format, not just continuation prompts. This ensures Claude always receives structured recovery instructions.
- Requirements: `stop_hook_active` guard logic needs design-phase decision -- unclear whether to skip continuation entirely or reduce prompt. Both approaches have tradeoffs.
- Requirements: Plugin version is currently 3.1.1 in both plugin.json and marketplace.json. Must bump to 3.2.0 (minor: new feature -- working loop) or similar.
- Requirements: The test helper `create_hook_input()` already passes `"stop_hook_active": true` in all tests, which means adding a guard for this field may cause existing test expectations to change significantly. Design phase must account for this.
- Requirements: Total scope is 4 files to change (stop-watcher.sh, stop-hook.bats, setup.bash, settings.json) plus 2 version bumps. Estimated S-M effort.
- Design: `stop_hook_active` guard placed ONLY on continuation path (not error paths). Corrupt state and max iterations errors still output JSON regardless of `stop_hook_active`, because Claude needs recovery instructions in those cases.
- Design: `create_hook_input()` default flipped from `stop_hook_active: true` to `false`. Real Claude Code sends `false` on first stop, `true` on subsequent. This makes tests more realistic and avoids masking the guard.
- Design: Multi-line `reason` content captured in bash variable via heredoc, then passed to `jq --arg`. This avoids JSON escaping issues with newlines and special characters.
- Design: state-management.bats also has 3 tests that assert stop hook continuation output -- these also need JSON updates. Total affected test files: 3 (not 2).
- Design: Version bump to 3.2.0 (minor) since this is a new feature (working loop), not a patch fix.
- Task planning: 17 total tasks across 5 phases. Phase 1 (POC) has 7 tasks focused on JSON output conversion. Phase 3 (Testing) is the heaviest with 7 tasks updating all 3 bats test files.
- Task planning: The `create_hook_input()` default flip from `true` to `false` is the highest-risk change. It affects `run_stop_watcher()` which is used by most tests. If existing tests break after task 1.2, the root cause is likely this default change combined with the new `stop_hook_active` guard in task 1.6.
- Task planning: No lint/typecheck/build commands exist for this project. Quality checkpoints use `bats tests/*.bats` exclusively.
- Task planning: Phase 2 is minimal (1 task) since the only refactoring needed is settings cleanup and version bump -- the core code changes are clean enough in Phase 1.
- Task planning: Test update order matters: stop-hook.bats first (most assertions to update), then integration.bats, then state-management.bats. Each file gets its own task for atomic commits.
- Task planning: 5 new tests added in task 3.4 cover: stop_hook_active=true guard, stop_hook_active=false JSON output, all 3 JSON fields present, max iterations JSON format, and corrupt state still fires with stop_hook_active=true (edge case from design).

- Task 1.6: `stop_hook_active` guard placed after `MAX_TASK_ITER` read and before DESIGN NOTE comment. Uses `jq -r '.stop_hook_active // false'` to read from hook input. Continuation prompt captured in `REASON` variable via heredoc, then `jq -n` outputs JSON with decision/reason/systemMessage. All 3 output paths now use identical JSON format.

### Verification: V1.5 [VERIFY] Quality checkpoint: bats tests (partial)
- Status: PASS
- All 58 bats tests pass (24 stop-hook, 10 integration, 24 state-management)
- Zero failures. The expected test breakage from `create_hook_input()` default flip and JSON output format changes did NOT materialize because: (a) the tests already assert plain text content like "Continue spec" and "ERROR:" which appear in the JSON reason field, and (b) `stop_hook_active` guard has not yet been added to the continuation path -- so the default flip has no observable effect yet.
- Corrupt state path: produces valid JSON (`{"decision":"block","reason":"ERROR: Corrupt state file...","systemMessage":"..."}`) -- confirmed by jq validation (exit 0)
- Max iterations path: produces valid JSON (`{"decision":"block","reason":"ERROR: Maximum global iterations...","systemMessage":"..."}`) -- confirmed by jq validation (exit 0)
- jq properly escapes newlines in reason field as `\n` (verified via xxd byte inspection)
- Note: jq-1.7.1-apple on macOS returns exit 0 even for parse errors with `jq empty`, but the corrupt state test still works because the stop-watcher.sh checks `jq empty "$STATE_FILE"` (file arg) not piped input, and that path correctly detects invalid JSON
- Duration: ~30s

### Verification: Task 1.7 POC Checkpoint - JSON output end-to-end
- Status: PASS
- Manual Test 1 (continuation JSON, stop_hook_active=false): PASS - Valid JSON with decision=block, reason contains "Continue spec", systemMessage contains "Ralph-specum"
- Manual Test 2 (stop_hook_active=true guard): PASS - No output produced (guard works correctly)
- Manual Test 3 (corrupt state JSON): PASS - Valid JSON with decision=block, reason contains "ERROR: Corrupt"
- Manual Test 4 (max iterations JSON): PASS - Valid JSON with decision=block, reason contains "Maximum global iterations"
- Bats: stop-hook.bats 24/24 PASS, integration.bats 10/10 PASS, state-management.bats 24/24 PASS
- Total: 58/58 bats tests pass, 0 failures
- Note: Initial test script used `echo "$OUTPUT" | jq` which failed due to shell command substitution mangling escaped newlines. Redirecting to file then validating with `jq file.json` works correctly. The JSON output from stop-watcher.sh is valid (jq --arg properly escapes newlines as \n).
- Duration: ~15s

### Verification: Task 3.3 [VERIFY] Quality checkpoint: bats stop-hook tests
- Status: FAIL
- Results: 17/24 pass, 7/24 fail
- Passing tests: 1-6, 10-16, 18-19, 23-24
- Failing tests: 7, 8, 9, 17, 20, 21, 22
- Root cause: Bats 1.13.0 `run` captures both stdout AND stderr into `$output` by default. The stop-watcher.sh line 147 writes a stderr log line (`[ralph-specum] Session stopped during spec: ...`) which gets prepended to the JSON output. The `assert_json_block` helper (setup.bash line 162) does `echo "$output" | jq empty` which fails because the output starts with a non-JSON log line before the JSON object.
- Tests 7, 8, 9, 17: `assert_json_block` fails because `$output` contains stderr log line + JSON (not pure JSON)
- Tests 20, 21, 22: `assert_json_reason_contains` fails because `echo "$output" | jq -r '.reason // empty'` gets jq parse error ("Invalid numeric literal at line 1, column 14") for same reason
- Fix needed: Either (a) update `assert_json_block` and `assert_json_reason_contains` to strip non-JSON prefix lines before parsing, or (b) use `run --separate-stderr` in tests, or (c) suppress the stderr log in the stop-watcher during tests
- Note: Tests 10-11 (corrupt state) pass because the corrupt state path does NOT write the stderr log line (it's only written when phase=execution on line 146-148), so the JSON output is clean
- Duration: ~8s

- Task 3.4: The "exits silently when stop_hook_active is true" test needed `2>/dev/null` on the bash command because bats `run` captures both stdout and stderr. The stop-watcher writes stderr log lines (line 147 session state + line 159 guard skip message) which make `[ -z "$output" ]` fail without stderr suppression.

## Next
Task 3.5 Update integration.bats assertions to JSON
