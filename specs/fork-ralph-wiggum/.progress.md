---
spec: fork-ralph-wiggum
created: 2026-02-14
---

# Progress: fork-ralph-wiggum

## Original Goal
In the past we removed the Ralph Wiggum plug-in and we tried to do it on our own but it's totally failing because it does not actually re-invoke Claude when it stops and it's a core problem. The idea is that we do not want to introduce the Ralph Wiggum plug-in as a dependency again. We want to fork Ralph Wiggum, extract all the relevant files, and use them directly in this repo.

## Interview Format
- Version: 1.0

## Intent Classification
- Type: GREENFIELD
- Confidence: high (4 keywords matched)
- Min questions: 5
- Max questions: 10
- Keywords matched: fork, extract, introduce, build

## Related Specs
- implement-ralph-wiggum [High]: Made /implement command run original Ralph Wiggum plugin
- remove-ralph-wiggum [High]: Removed ralph-loop dependency for self-contained execution (v3.0.0)
- return-ralph-wrigum [Medium]: Recently created, empty

## Codebase Research (Auto-gathered)

### Core Problem
The self-contained stop-hook approach (v3.0.0) fails because Stop hooks are one-way output only. They run AFTER Claude finishes responding and output text, but that text is NOT fed back into Claude's processing pipeline. The stop-watcher.sh was essentially outputting prompts to /dev/null architecturally.

### What Ralph Wiggum Does Differently
- Uses `/ralph-loop` command with explicit iteration support
- Can block Claude's exit (exit code 2) and re-inject prompts
- Handles the loop at the command/plugin level, not at the hook level
- Uses Claude Code's native capabilities for session continuation

### Key Files Involved
- `plugins/ralph-specum/commands/implement.md` - coordinator prompt
- `plugins/ralph-specum/hooks/scripts/stop-watcher.sh` - stop hook (currently just logging/cleanup)
- `plugins/ralph-specum/hooks/hooks.json` - hook registration
- `.ralph-state.json` - execution state

## Interview Responses

### Goal Interview (from start.md)
- Problem: Both - need the loop to work AND want it owned in this repo (no external dependency)
- Constraints: Selective extraction - cherry-pick specific components (loop command, stop hook integration, etc.)
- Success criteria: Loop works end-to-end, no external deps, and existing bats tests still pass
- Location: Shared lib directory - create plugins/ralph-specum/lib/ for the forked loop mechanism
- Source: Ralph Wiggum is a public package on npm/GitHub, can examine during research
- Additional context: None, proceed with research

### Requirements Interview (from requirements.md)
- Primary users: Both developers and end users (plugin developers AND marketplace consumers)
- Priority tradeoffs: Prioritize speed of delivery - get the loop working ASAP with minimal changes
- Success criteria: Feature works as specified - loop correctly re-invokes Claude, executes tasks sequentially until ALL_TASKS_COMPLETE

### Design Interview (from design.md)
- Architecture style: Extend existing architecture - modify stop-watcher.sh in-place, keep all existing logic, just change output format
- Technology constraints: No constraints - keep using jq for JSON output, same dependencies
- Guard logic: Stop hook should ONLY be active during execution phase (implement). During research, design, and task phases it should NOT block Claude from stopping. Small caveat for quick mode.

### Tasks Interview (from tasks.md)
- Testing depth: Standard - unit + integration (update existing bats tests, add new guard tests)
- Execution priority: Balanced - reasonable quality with speed

## Completed Tasks
- [x] 1.1 Add JSON assertion helpers to test setup
- [x] 1.2 Parameterize hook input helpers with stop_hook_active

## Current Task
Awaiting next task

## Learnings
- The stop-watcher.sh failure is NOT architectural -- it's a JSON output format issue. Plain text stdout on exit 0 is only shown in verbose mode for Stop hooks. The fix is to output `{"decision":"block","reason":"..."}` JSON.
- Ralph Wiggum's `/ralph-loop` command is just a wrapper that creates a state file. The actual loop mechanism is entirely in the Stop hook's JSON output format -- identical hook type to what we already have.
- No need to create `lib/` directory or fork files. The existing stop-watcher.sh already has all the logic (state reading, transcript detection, path resolution). Only the output format needs changing.
- Historical plugin hook bugs (#10412, #10875) where plugin stdout wasn't captured are now CLOSED/FIXED. The official Ralph Wiggum plugin works via the same mechanism.
- `stop_hook_active` field in hook input (boolean) indicates whether Claude is already in a continuation loop -- should be checked to prevent infinite rapid re-invocation.
- `.claude/settings.json` currently has BOTH `ralph-wiggum@claude-plugins-official` AND `ralph-specum@smart-ralph` enabled, which means two competing Stop hooks fire. Must remove ralph-wiggum to avoid conflicts.
- Existing bats tests (18 tests in stop-hook.bats) will need updating from plain text assertions to JSON assertions.
- Requirements: Error cases (corrupt state, max iterations) should also output JSON format, not just continuation prompts. This ensures Claude always receives structured recovery instructions.
- Requirements: `stop_hook_active` guard logic needs design-phase decision -- unclear whether to skip continuation entirely or reduce prompt. Both approaches have tradeoffs.
- Requirements: Plugin version is currently 3.1.1 in both plugin.json and marketplace.json. Must bump to 3.2.0 (minor: new feature -- working loop) or similar.
- Requirements: The test helper `create_hook_input()` already passes `"stop_hook_active": true` in all tests, which means adding a guard for this field may cause existing test expectations to change significantly. Design phase must account for this.
- Requirements: Total scope is 4 files to change (stop-watcher.sh, stop-hook.bats, setup.bash, settings.json) plus 2 version bumps. Estimated S-M effort.
- Design: `stop_hook_active` guard placed ONLY on continuation path (not error paths). Corrupt state and max iterations errors still output JSON regardless of `stop_hook_active`, because Claude needs recovery instructions in those cases.
- Design: `create_hook_input()` default flipped from `stop_hook_active: true` to `false`. Real Claude Code sends `false` on first stop, `true` on subsequent. This makes tests more realistic and avoids masking the guard.
- Design: Multi-line `reason` content captured in bash variable via heredoc, then passed to `jq --arg`. This avoids JSON escaping issues with newlines and special characters.
- Design: state-management.bats also has 3 tests that assert stop hook continuation output -- these also need JSON updates. Total affected test files: 3 (not 2).
- Design: Version bump to 3.2.0 (minor) since this is a new feature (working loop), not a patch fix.
- Task planning: 17 total tasks across 5 phases. Phase 1 (POC) has 7 tasks focused on JSON output conversion. Phase 3 (Testing) is the heaviest with 7 tasks updating all 3 bats test files.
- Task planning: The `create_hook_input()` default flip from `true` to `false` is the highest-risk change. It affects `run_stop_watcher()` which is used by most tests. If existing tests break after task 1.2, the root cause is likely this default change combined with the new `stop_hook_active` guard in task 1.6.
- Task planning: No lint/typecheck/build commands exist for this project. Quality checkpoints use `bats tests/*.bats` exclusively.
- Task planning: Phase 2 is minimal (1 task) since the only refactoring needed is settings cleanup and version bump -- the core code changes are clean enough in Phase 1.
- Task planning: Test update order matters: stop-hook.bats first (most assertions to update), then integration.bats, then state-management.bats. Each file gets its own task for atomic commits.
- Task planning: 5 new tests added in task 3.4 cover: stop_hook_active=true guard, stop_hook_active=false JSON output, all 3 JSON fields present, max iterations JSON format, and corrupt state still fires with stop_hook_active=true (edge case from design).
