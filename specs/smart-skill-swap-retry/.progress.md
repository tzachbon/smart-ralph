# Progress: smart-skill-swap-retry

## Goal
I want that on smart start it will try to look for and swap every skill it deems necessary, and also retry it after research if it missed something.

## Goal Type
- Type: add (enhance existing feature)

## Completed Tasks
- [x] 1.1 Add discoveredSkills to state initialization in start.md (normal mode)
- [x] 1.2 Add discoveredSkills to state initialization in quick-mode.md
- [x] 1.3 Add Skill Discovery Pass 1 to start.md (normal mode, Step 2.5)
- [x] 1.5 Add Skill Discovery Pass 2 to start.md (normal mode, post-research)
- [x] 1.6 Add Skill Discovery Pass 1 to quick-mode.md (Step 8.5)
- [x] 1.8 Add Skill Discovery Pass 2 to quick-mode.md (Step 10.5)
- [x] 1.9 Add error handling instructions to both discovery passes

## Completed Tasks (Phase 2)
- [x] 2.1 Ensure tokenization rules are identically worded in all 4 passes

- [x] 2.2 Clean up step numbering in start.md
- [x] 2.3 Clean up step numbering in quick-mode.md

## Completed Tasks (Phase 4)
- [x] 4.1 Bump plugin version

## Current Task
Awaiting next task

### Task 2.1 Completion
- Verified all 4 tokenization rule blocks are already word-for-word identical across start.md Pass 1 (line 51-56), start.md Pass 2 (line 151-156), quick-mode.md Pass 1 (line 105-110), quick-mode.md Pass 2 (line 136-141)
- Stopword list matches in all 4: a, an, the, to, for, with, and, or, in, on, by, is, be, that, this, of, it, should, used, when, asks, needs, about (25 words)
- No changes needed -- POC phase already established identical wording

### Task 1.9 Completion
- Added error handling for 4 scenarios to all 4 discovery insertion points (start.md Pass 1 + Pass 2, quick-mode.md Pass 1 + Pass 2)
- Scenarios: unreadable SKILL.md (skip + log warning), missing description (skip + log "no description"), Skill invocation failure (set invoked: false + log warning + continue), no matches (log "No skills matched")
- Added "skipped (unreadable)" and "skipped (no description)" entries to progress logging format in all 4 passes

### Task 1.8 Completion
- Added Step 10.5 (Skill Discovery Pass 2) to quick-mode.md between step 10 (Research) and step 11 (Requirements)
- Added both code block entry and detailed ## section with full discovery instructions
- Uses goal text + Executive Summary from research.md as context, matchedAt: "post-research"
- Logs to progress under ### Post-Research Retry

## Learnings
- All 6 ralph-specum skills have `description` in YAML frontmatter -- this is the matching surface
- Skills with `user-invocable: false` (interview-framework, reality-verification, delegation-principle, communication-style) should still be auto-discoverable
- Two clear insertion points: after Step 2 (input parsing) and after research.md creation (before requirements)
- The Skill tool (`Skill({ skill: "ralph-specum:<name>" })`) is the correct invocation mechanism
- Keyword matching is sufficient for ~6 skills; semantic matching would be overengineered
- Both quick mode and normal mode should auto-invoke without prompts (skills are additive context)
- `discoveredSkills` array in .ralph-state.json prevents duplicate invocations across passes
- Skill descriptions contain many generic words ("should", "used", "when", "asks") that need stopword filtering to avoid false positives
- Threshold of 2 keyword overlaps balances precision vs recall for 6 skills
- No separate reference file needed -- only 2 insertion points with minor context differences (goal-only vs goal+summary)
- Post-research pass should use Executive Summary section only, not full research.md (too noisy)
- Resume flow should NOT re-run discovery -- skills were loaded in original session context
- Coordinator performs discovery inline (reading frontmatter + matching) -- this is coordination work, not implementation requiring subagent delegation
- start.md Step 2.5 is normal mode only -- quick mode jumps from Step 2 to Step 5 (quick-mode.md), so it never hits Step 2.5. Quick mode gets Pass 1 at quick-mode.md step 8.5 instead
- Tokenization must treat hyphens as word separators (skill descriptions use them: "brainstorming-style"), strip parentheses/commas/punctuation, and compare case-insensitively
- Task planning: 4 insertion points total (2 in start.md for normal mode, 2 in quick-mode.md for quick mode) -- each self-contained inline
- Task planning: state init happens in 2 places (start.md step 7 for normal, quick-mode.md step 5 for quick) -- both need discoveredSkills: []
- Task planning: no build/lint/typecheck commands exist for this plugin -- quality gates are structural grep checks on markdown content
- Task planning: version bump is 4.1.2 -> 4.2.0 (minor, new feature) in both plugin.json and marketplace.json
- Task planning: start.md normal mode New Flow step numbering is 1-12; insert post-research pass after step 11 (Team Research) before step 12 (STOP)
- Pass 2 inserted as step 12, STOP renumbered to step 13. New Flow is now steps 1-13
- Step 2.5 renumbered to Step 3, cascading: Step 3->4, Step 4->5, Step 5->6. Top-level steps now 1-6 sequential. "Skip to Step 5" references updated to "Step 6"
- quick-mode.md uses compact code block for step listing + separate ## sections for detailed instructions. Pass 1 added as both step 8.5 in code block and ## Step 8.5 section with full instructions
- Pass 2 in quick-mode.md follows same pattern: code block entry at 10.5 + detailed ## Step 10.5 section. Mirrors start.md Pass 2 structure exactly.
- quick-mode.md renumbered from X.5 (8.5, 10.5) to clean integers 1-17. Step 8.5->9, old 9->10, old 10->11, Step 10.5->12, old 11->13, old 12->14, old 13->15, old 14->16, old 15->17. Section headers and cross-references updated: "steps 11-15" for directive, "steps 13-15" for review loop.

### Verification: 1.4 [VERIFY] Quality checkpoint: grep for consistent terminology
- Status: PASS
- discoveredSkills count in start.md: 4 (threshold >= 2) -- PASS
- matchedAt count in start.md: 2 (threshold >= 1) -- PASS
- invoked count in start.md: 3 (present in both success and failure paths) -- PASS
- Terminology cross-check with design.md: all field names (discoveredSkills, matchedAt, invoked), values ("start", "post-research", true/false), and object structure ({ name, matchedAt, invoked }) match exactly
- No fixes needed

### Verification: 1.7 [VERIFY] Quality checkpoint: both files have Pass 1
- Status: PASS
- 'Skill Discovery Pass 1' in start.md: 1 (threshold >= 1) -- PASS
- 'Skill Discovery Pass 1' in quick-mode.md: 2 (threshold >= 1) -- PASS
- 'overlap >= 2' in start.md: 2 (threshold >= 1) -- PASS
- 'overlap >= 2' in quick-mode.md: 1 (threshold >= 1) -- PASS
- Both files contain Pass 1 instructions with matching algorithm and threshold
- No fixes needed

### Verification: 1.10 [VERIFY] Quality checkpoint: full content verification
- Status: PASS
- 'Skill Discovery' in start.md: 6 (threshold >= 2) -- PASS
- 'Skill Discovery' in quick-mode.md: 7 (threshold >= 2) -- PASS
- 'discoveredSkills' in start.md: 7 (threshold >= 3) -- PASS
- 'discoveredSkills' in quick-mode.md: 7 (threshold >= 3) -- PASS
- 'stopwords' in start.md: 2 (threshold >= 1) -- PASS
- 'stopwords' in quick-mode.md: 2 (threshold >= 1) -- PASS
- All 4 discovery insertion points verified with required elements
- No fixes needed

### Verification: 1.11 POC Checkpoint: verify feature works end-to-end
- Status: PASS
- Normal mode flow traced: Step 1 -> Step 2 -> Step 2.5 (Pass 1) -> Step 3 -> Step 4 (New Flow steps 1-11) -> Step 12 (Pass 2) -> Step 13 (STOP) -- correct, no gaps
- Quick mode flow traced: steps 1-8 -> 8.5 (Pass 1) -> 9-10 -> 10.5 (Pass 2) -> 11-15 -- correct, no gaps
- Step numbering: no conflicts found. start.md uses Step 1/2/2.5/3/4/5 top-level and 1-13 in New Flow. quick-mode.md uses 1-8, 8.5, 9-10, 10.5, 11-15 with matching ## sections
- Cross-references verified: "skip to Step 5" (line 39) correctly points to Step 5 (line 203), Step 2.5 note correctly says quick mode skips to Step 5
- Tokenization rules identical across all 4 insertion points (start.md Pass 1 line 51-56, Pass 2 line 151-156; quick-mode.md Pass 1 line 105-110, Pass 2 line 136-141)
- Stopword list identical across all 4: a, an, the, to, for, with, and, or, in, on, by, is, be, that, this, of, it, should, used, when, asks, needs, about (25 words)
- `ralph-specum:<name>` Skill invocation syntax: 2 occurrences in start.md (>= 1) -- PASS
- `ralph-specum:<name>` Skill invocation syntax: 2 occurrences in quick-mode.md (>= 1) -- PASS
- No fixes needed

### Verification: 3.1 Verify all 6 skills are discoverable via frontmatter
- Status: PASS
- All 6 skill directories found: communication-style, delegation-principle, interview-framework, reality-verification, smart-ralph, spec-workflow
- All 6 SKILL.md files have `name` field in YAML frontmatter matching directory basename
- All 6 SKILL.md files have `description` field in YAML frontmatter
- Invocation syntax `ralph-specum:<name>` matches directory names for all 6
- Verification command (`for d in ... grep -l ...`) output 6 matches, 0 MISSING lines
- No fixes needed

### Verification: 2.4 [VERIFY] Quality checkpoint: refactoring consistency
- Status: PASS
- 'Skill Discovery' in start.md: 6 (threshold >= 2) -- PASS
- 'Skill Discovery' in quick-mode.md: 7 (threshold >= 2) -- PASS
- start.md step headers: Step 1, 2, 3, 4, 5, 6 -- sequential integers, no X.5 steps -- PASS
- start.md New Flow sub-steps: 1-13 -- sequential integers, no X.5 -- PASS
- quick-mode.md execution sequence: 1-17 -- sequential integers, no X.5 -- PASS
- quick-mode.md section headers: ## Step 9, ## Step 12 -- match code block numbers -- PASS
- Quick Mode Check cross-ref: "skip to Step 6" matches ## Step 6 header -- PASS
- Quick Mode Directive: "steps 11-15" covers agent delegation steps correctly -- PASS
- Review Loop: "steps 13-15" covers Requirements/Design/Tasks correctly -- PASS
- No broken "Step N" references found in either file
- No X.5 step numbers remain in quick-mode.md
- No fixes needed

### Verification: 3.2 Verify tokenization handles existing skill descriptions correctly
- Status: PASS
- Source: interview-framework SKILL.md description = "Adaptive brainstorming-style dialogue for all spec phases (Understand, Propose Approaches, Confirm & Store)"
- Tokenization steps applied:
  1. Lowercase: "adaptive brainstorming-style dialogue for all spec phases (understand, propose approaches, confirm & store)"
  2. Hyphens->spaces: "adaptive brainstorming style dialogue for all spec phases (understand, propose approaches, confirm & store)"
  3. Strip punctuation: "adaptive brainstorming style dialogue for all spec phases understand propose approaches confirm store"
  4. Split: 13 tokens
  5. Remove stopwords ("for" removed): 12 tokens remaining
- Final tokens: ["adaptive", "brainstorming", "style", "dialogue", "all", "spec", "phases", "understand", "propose", "approaches", "confirm", "store"]
- Matches expected output from task description exactly
- Sample goal test: "Add adaptive brainstorming for goal exploration"
  - Goal tokens after tokenization: ["add", "adaptive", "brainstorming", "goal", "exploration"]
  - Overlap with skill tokens: ["adaptive", "brainstorming"] = 2 words
  - 2 >= 2 (threshold) -> MATCH confirmed
- Tokenization rules verified against start.md lines 52-56 (identical in all 4 discovery passes per task 2.1)
- No fixes needed

### Verification: 3.3 Verify discovery instructions reference correct CLAUDE_PLUGIN_ROOT path
- Status: PASS
- CLAUDE_PLUGIN_ROOT in start.md: 8 occurrences (threshold >= 2) -- PASS
  - Skills path refs: line 47 (Pass 1), line 147 (Pass 2) use `${CLAUDE_PLUGIN_ROOT}/skills/*/SKILL.md`
  - Other refs: branch-management, intent-classification, spec-scanner, goal-interview, parallel-research, quick-mode
- CLAUDE_PLUGIN_ROOT in quick-mode.md: 2 occurrences (threshold >= 1) -- PASS
  - Skills path refs: line 101 (Pass 1), line 132 (Pass 2) use `${CLAUDE_PLUGIN_ROOT}/skills/*/SKILL.md`
- Skill invocation pattern `ralph-specum:<name>` in start.md: 2 Skill tool invocations (lines 59, 159) -- PASS
- Skill invocation pattern `ralph-specum:<name>` in quick-mode.md: 2 Skill tool invocations (lines 113, 144) -- PASS
- No hardcoded paths to skills directory found -- all use CLAUDE_PLUGIN_ROOT variable
- No fixes needed

### Verification: 3.4 [VERIFY] Quality checkpoint: content completeness
- Status: PASS
- discoveredSkills in start.md: 7 (threshold >= 3) -- PASS
- discoveredSkills in quick-mode.md: 7 (threshold >= 3) -- PASS
- matchedAt in start.md: 4 (threshold >= 2) -- PASS
- matchedAt in quick-mode.md: 4 (threshold >= 2) -- PASS
- invoked in start.md: 7 (threshold >= 2) -- PASS
- invoked in quick-mode.md: 7 (threshold >= 2) -- PASS
- Post-Research in start.md: 3 (threshold >= 1) -- PASS
- Post-Research in quick-mode.md: 3 (threshold >= 1) -- PASS
- progress.md in start.md: 4 (threshold >= 2) -- PASS
- progress.md in quick-mode.md: 5 (threshold >= 2) -- PASS
- All 10 structural content checks passed with counts well above thresholds
- No fixes needed

### Verification: 3.5 Verify AC coverage by tracing each acceptance criterion
- Status: PASS
- All 22 ACs traced to implementation in start.md and/or quick-mode.md
- AC-1.1: PASS -- start.md line 47, quick-mode.md line 101 read SKILL.md frontmatter via CLAUDE_PLUGIN_ROOT/skills/*/SKILL.md
- AC-1.2: PASS -- start.md lines 51-57, quick-mode.md lines 105-111 implement tokenization + overlap >= 2
- AC-1.3: PASS -- start.md line 59, quick-mode.md line 113 invoke via Skill({ skill: "ralph-specum:<name>" })
- AC-1.4: PASS -- no filtering on user-invocable field in either file (verified via grep: 0 matches)
- AC-1.5: PASS -- start.md Step 3 (after Step 2 input parsing, before Step 4/5 phase work); quick-mode.md step 9 (after step 8, before step 10/11)
- AC-2.1: PASS -- start.md step 12, quick-mode.md step 12 use goal text + Executive Summary from research.md
- AC-2.2: PASS -- start.md line 158, quick-mode.md line 143 skip skills already in discoveredSkills with invoked: true
- AC-2.3: PASS -- start.md Pass 2 at step 12 before STOP (step 13); quick-mode.md Pass 2 at step 12 before Requirements (step 13)
- AC-2.4: PASS -- Pass 2 exists in both start.md (step 12) and quick-mode.md (step 12)
- AC-3.1: PASS -- discoveredSkills: [] in state init (start.md line 134, quick-mode.md line 75); objects have { name, matchedAt, invoked }
- AC-3.2: PASS -- matchedAt: "start" (Pass 1) and "post-research" (Pass 2) in both files
- AC-3.3: PASS -- invoked: true on success, invoked: false on failure in all 4 passes
- AC-3.4: PASS -- "Update .ralph-state.json with updated discoveredSkills array" in all 4 passes
- AC-4.1: PASS -- "Append a ## Skill Discovery section to .progress.md" in Pass 1 of both files
- AC-4.2: PASS -- format includes "matched (keywords: <overlapping words>)" in all passes
- AC-4.3: PASS -- "### Post-Research Retry" subsection appended in Pass 2 of both files
- AC-4.4: PASS -- "No skills matched" (Pass 1) / "No new skills matched" (Pass 2) logged explicitly
- AC-5.1: PASS -- quick-mode.md has no confirmation prompts in discovery steps
- AC-5.2: PASS -- start.md has no confirmation prompts in discovery steps
- AC-5.3: PASS -- all 4 passes: "set invoked: false, log warning, continue" on failure
- Gaps found: 0
- No fixes needed
