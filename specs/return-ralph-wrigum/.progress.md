---
spec: return-ralph-wrigum
created: 2026-02-14
---

# Progress: return-ralph-wrigum

## Original Goal
In some PR we added or merged, we removed the Ralph Wrigum. Unfortunately we need to return it back. Let's plan how we do it. Make sure to look online: how the newest Ralph Wrigum is used, how it is required to be installed, how a user needs to be installed, how we should return it to the implement phase, how we revert it safely. We need to do all of that. Your output should be a PR at the end of the day.

## Completed Tasks
- [x] 1.1 Strip loop control output from stop-watcher.sh
- [x] 1.2 Add Ralph Wiggum dependency check to implement.md
- [x] 1.3 Modify implement.md to invoke /ralph-loop instead of outputting prompt directly
- [x] 1.5 Update cancel.md to call /cancel-ralph
- [x] 2.1 Bump version to 4.0.0 in both manifests
- [x] 2.2 Update README.md with Ralph Wiggum dependency
- [x] 2.3 Update CLAUDE.md with dependency information
- [x] 3.2 Update state-management.bats for Ralph Wiggum integration

## Current Task
Awaiting next task

## Learnings
- stop-watcher.sh continuation prompt block was ~30 lines (lines 131-161 original), including RECOVERY_MODE/MAX_TASK_ITER reads that only served the prompt
- Ralph Wiggum plugin is at `anthropics/claude-code/plugins/ralph-wiggum/`, installed via `/plugin install ralph-wiggum@claude-plugins-official`
- Known bug: `--max-iterations=N` (equals syntax) silently ignored, must use space syntax `--max-iterations N`
- Known issue: Ralph Wiggum accumulates context (growing tokens per iteration) unlike original Ralph technique
- Hook coexistence is the primary risk: both Ralph Wiggum and our plugin register Stop hooks. Our stop-watcher.sh must be made completely passive (no stdout output) to avoid conflicts.
- The current codebase (v3.1.1) has 39 bats-core tests that assume stop-watcher.sh controls the loop - these need updating
- Ralph Wiggum state lives in `.claude/ralph-loop.local.md` (YAML frontmatter + prompt body), separate from our `.ralph-state.json`
- v3.0.0 added significant improvements over v2.0.0: recovery mode, fix-task generation, global iteration limits, multi-directory support, parallel group detection - ALL must be preserved in coordinator prompt passed to ralph-loop
- The coordinator prompt in implement.md is ~1000+ lines - this entire prompt gets passed as the ralph-loop prompt argument
- cancel.md was simplified in v3.0.0 to just file deletion + spec removal - needs /cancel-ralph added back
- Version should go to 4.0.0 since this is another breaking change (requires external dependency)
- implement.md now passes coordinator prompt to ralph-loop via Skill tool; maxIterations = totalTasks * maxTaskIterations * 2; uses space syntax for --max-iterations (not equals)
- cancel.md now invokes /cancel-ralph via Skill tool before file cleanup; added Skill to allowed-tools; /cancel-ralph failure is non-blocking (expected if no active loop)
- bats `run` captures both stdout AND stderr in $output; stop-watcher stderr logging appears in test output, so tests must use assert_output_not_contains instead of [ -z "$output" ] for execution-phase tests
- 5 state-management tests referenced "Continue" prompt output and needed updating to verify passive behavior (no continuation prompts) instead

### Verification: 1.4 [VERIFY] Quality checkpoint: implement.md structure
- Status: PASS
- Frontmatter: Valid YAML with --- delimiters, description, argument-hint, allowed-tools
- ralph-loop invocation: Space syntax confirmed (line 95), no equals syntax in invocations
- completion-promise: "ALL_TASKS_COMPLETE" confirmed (line 95)
- COORDINATOR role: Present (lines 112, 116)
- spec-executor delegation: Present (10+ references)
- Dependency check: Section exists (lines 37-47) with install instructions for ralph-wiggum@claude-plugins-official

### Verification: 1.6 [VERIFY] POC Checkpoint: structural validation
- Status: PASS
- implement.md uses ralph-loop: YES (10 references, line 95 invocation)
- implement.md dependency check: YES (lines 37-47, "Check Ralph Wiggum Dependency" section)
- implement.md completion-promise: YES (line 95, --completion-promise "ALL_TASKS_COMPLETE")
- cancel.md uses cancel-ralph: YES (line 60, invoked BEFORE file cleanup on line 64+)
- cancel.md ordering: CORRECT (/cancel-ralph at line 60, Cleanup section starts at line 64)
- stop-watcher.sh passive: YES (no "Continue spec:" prompt, only stderr logging on line 127)
- stop-watcher.sh stdout: Error-only (lines 90,112 are error condition messages, not loop control)
- Existing logic intact: spec-executor (26 refs), qa-engineer (5 refs), ralph-state.json (20 refs), TASK_COMPLETE (28 refs)
- No regressions detected

### Verification: 2.4 [VERIFY] Quality checkpoint: documentation and version
- Status: PASS (with minor inconsistencies noted)
- Verify command: `grep -q '"version": "4.0.0"' ... && echo "PASS"` => PASS (exit 0)
- plugin.json version: 4.0.0 (PASS)
- marketplace.json version: 4.0.0 (PASS)
- README.md mentions ralph-wiggum: YES (6 references: lines 15, 44, 48, 411, 434, 437)
- CLAUDE.md mentions ralph-wiggum: YES (3 references: lines 105, 107, 120)
- README install instructions: Present (lines 40-55, step-by-step with Ralph Wiggum first)
- README breaking changes v4.0.0: Present (lines 430-450, migration guide included)
- CLAUDE.md execution flow: Updated (line 70, references /ralph-loop and passive stop-watcher)
- CLAUDE.md dependencies section: Updated (lines 105-109, explains Ralph Wiggum requirement)
- CLAUDE.md dependency note: Present (line 120, explains implement.md and cancel.md usage)
- Minor inconsistencies (non-blocking):
  - CLAUDE.md line 62: Plugin Structure says "controls execution loop continuation" (stale, should say "passive logging/cleanup")
  - CLAUDE.md line 115: Key Files says "Execution loop controller (outputs continuation prompts)" (stale, should say "passive logging/cleanup")
  - README.md line 300: Project Structure says "controls execution loop" (stale, should say "passive logging")
  - These are cosmetic inconsistencies within comment annotations; the actual behavioral descriptions (lines 70, 109) are correct
