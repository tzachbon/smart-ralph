# Progress: qa-verification

## Goal
Add verification capability through [VERIFY] tagged tasks that integrate quality checks into the task flow.

## Source
GitHub Issue: https://github.com/tzachbon/smart-ralph/issues/14

## Key Requirements
- Create qa-engineer agent for running verification commands
- Integrate verification as [VERIFY] tasks (not separate phase)
- Research phase discovers actual project quality commands
- spec-executor delegates [VERIFY] tasks to qa-engineer
- Final sequence: V4 local CI, V5 remote CI, V6 AC checklist

## Phase Log
- [x] Research
- [x] Requirements
- [x] Design
- [x] Tasks
- [ ] Execution

## Completed Tasks
- [x] 1.1 Create qa-engineer agent
- [x] 1.2 Update spec-executor with [VERIFY] detection and delegation
- [x] 1.3 [VERIFY] Quality checkpoint: qa-engineer and spec-executor
- [x] 1.4 Update task-planner with [VERIFY] task format
- [x] 1.5 Update research-analyst with quality command discovery
- [x] 1.6 [VERIFY] Quality checkpoint: task-planner and research-analyst
- [x] 2.1 Improve qa-engineer error handling

## Learnings

### Research Phase
- Phase enum hardcoded in schema but NOT needed for this approach (no new phase)
- Task-planner already has "Quality Checkpoint" pattern that can be extended with [VERIFY] tag
- spec-executor has Task tool available for subagent delegation
- Quality commands vary by project. Must discover from package.json/Makefile/CI configs
- Industry best practice: verification should have explicit pass/fail criteria mapped to requirements ACs
- Inline quality gates (embedded in task flow) preferred over separate phases in modern CI/CD

### Requirements Phase (Updated Model)
- [VERIFY] tasks replace separate verification phase for simpler architecture
- No schema phase enum update needed
- No stop-handler.sh phase logic changes needed
- No /ralph-specum:verify command needed (verification is inline)
- spec-executor delegates [VERIFY] tasks to qa-engineer via Task tool
- On VERIFICATION_FAIL, task stays unchecked for retry
- Results logged in .progress.md Learnings (no separate verification.md)
- Final sequence must be V4 (local CI) then V5 (remote CI) then V6 (AC checklist)

### Design Phase (Integrated Model)
- 4 files to modify: qa-engineer.md (create), spec-executor.md, task-planner.md, research-analyst.md
- 6 files NOT needed: verify.md, spec.schema.json, stop-handler.sh, verification.md template, start.md, help.md
- [VERIFY] task format: `V1 [VERIFY] Description: commands`
- qa-engineer receives task via Task tool, runs commands, outputs VERIFICATION_PASS/FAIL
- research-analyst must add Quality Commands section to research.md
- task-planner uses discovered commands in [VERIFY] tasks
- Local-first verification order catches issues before push, saves CI resources
- Backward compatible: specs without [VERIFY] tasks work normally

### Tasks Phase
- [NEW] 18 total tasks planned across 4 phases
- [NEW] Phase 1 (POC): 7 tasks to create qa-engineer and update 3 existing agents
- [NEW] Phase 2 (Refactoring): 3 tasks for error handling improvements
- [NEW] Phase 3 (Testing): 4 tasks for design validation (no automated tests for markdown)
- [NEW] Phase 4 (Quality Gates): 4 tasks including V4/V5/V6 final verification sequence
- [NEW] Each [VERIFY] checkpoint uses actual file existence/grep commands since no build step
- [NEW] AC checklist (V6) covers all 24 acceptance criteria from requirements.md
- [NEW] Dependency order: qa-engineer first (delegation target), then spec-executor, then task-planner, then research-analyst
- [NEW] No runtime tests possible for agent markdown files, validation via grep/structure checks

### Tasks Regeneration
- [NEW] [VERIFY] tasks must have concrete verification commands, not vague descriptions
- [NEW] Each verification step uses grep/test with explicit exit codes and error messages
- [NEW] V4 validates all 27 patterns across 4 agent files with labeled PASS/FAIL output
- [NEW] V5 uses gh CLI to verify PR state and CI checks programmatically
- [NEW] V6 runs 24 AC-specific grep patterns with per-AC PASS/FAIL and line order verification for AC-4.4
- [NEW] All [VERIFY] tasks include bash code blocks with || exit 1 for clear pass/fail semantics

### Execution Phase
- [x] 1.1 qa-engineer.md created with frontmatter (name, description, model: inherit, tools), When Invoked section, execution flow, AC checklist handling, output formats, and mandatory block for VERIFICATION_FAIL conditions
- [x] 1.2 spec-executor.md updated with [VERIFY] Task Handling section after Phase-Specific Rules. Contains mandatory block with detection logic, Task tool delegation format, VERIFICATION_PASS/FAIL result handling, and "never execute directly" rule
- [x] 1.3 [VERIFY] checkpoint passed: all 6 verification commands succeeded (qa-engineer.md exists with name/PASS/FAIL signals, spec-executor.md has [VERIFY] section and qa-engineer reference)
- [x] 1.4 task-planner.md updated with [VERIFY] Task Format section after Intermediate Quality Gate Checkpoints. Added standard checkpoint format, final V4/V5/V6 sequence, research.md discovery note. Updated 4 existing checkpoint examples to use [VERIFY] tag. Verification count: 11 occurrences > 10 threshold.
- [x] 1.5 research-analyst.md updated with Step 2.6: Quality Command Discovery section after Related Specs Discovery. Added mandatory block with sources to check (package.json, Makefile, CI configs), specific discovery commands to run, output format for research.md Quality Commands section, and note about marking missing commands as "Not found". Verification count: 4 occurrences > 3 threshold.
- [x] 1.6 [VERIFY] checkpoint passed: all 7 verification commands succeeded (task-planner.md has [VERIFY] Task Format section with V4/V5/V6, research-analyst.md has Quality Command Discovery with package.json and Makefile sources)
- [x] 1.7 [VERIFY] POC Checkpoint passed: all 12 verification commands succeeded across all 4 agent files (qa-engineer.md with VERIFICATION signals and mandatory block, spec-executor.md with [VERIFY] handling and Task tool, task-planner.md with V4/V5/V6 format, research-analyst.md with Quality Command Discovery)
- [x] 2.1 qa-engineer.md already has complete error handling from POC: Error Handling table (5 scenarios), timeout handling (FAIL on timeout), Output Truncation section (50 lines limit), SKIP logic (missing commands, optional files, ambiguous ACs), Progress Logging section with pass/fail examples. Verification: 11 matches > 2 threshold.
- [x] 2.2 spec-executor.md [VERIFY] section enhanced with retry mechanism context, .progress.md failure logging instructions, and commit rule for spec files. Verification: 14 matches > 3 threshold.
- [x] 2.3 [VERIFY] Quality checkpoint passed: all 5 verification commands succeeded (qa-engineer.md has SKIP/timeout/truncate/.progress.md, spec-executor.md has retry/.progress.md references). No fixes needed.
- [x] 3.1 Validated qa-engineer.md against design.md Component 1: frontmatter matches (name, description, model: inherit, tools), VERIFICATION_PASS/FAIL output format matches, AC checklist table format matches, mandatory block present. No corrections needed.
- [x] 3.2 Validated spec-executor.md [VERIFY] section against design.md Component 2: detection logic (line 86), Task tool delegation format (lines 88-99), VERIFICATION_PASS/FAIL handling (lines 102-113), mandatory block (lines 81-127). All match design. No corrections needed.
- [x] 3.3 Validated task-planner.md [VERIFY] Task Format section against design.md Component 3: [VERIFY] task format (lines 86-93), final V4/V5/V6 sequence in correct order (lines 97, 103, 109), mandatory block (lines 83-117), research.md discovery reference (line 116). All match design. No corrections needed.
- [x] 3.4 [VERIFY] Quality checkpoint passed: all 8 verification commands succeeded (qa-engineer.md has name/tools/When Invoked, spec-executor.md has [VERIFY] Task Handling/Task tool, task-planner.md has [VERIFY] Task Format/research.md ref, research-analyst.md has Quality Command Discovery). No fixes needed.
- [x] 4.1 Local quality check passed: all 4 grep verification commands returned matches (qa-engineer.md has VERIFICATION content, spec-executor.md has [VERIFY] section, task-planner.md has [VERIFY] format, research-analyst.md has Quality Command Discovery). No fixes needed.
- [x] 4.2 PR #25 created and pushed. No CI checks configured on repo (plugin-only with markdown files). PR open at https://github.com/tzachbon/smart-ralph/pull/25

## Current Task
Awaiting next task

## Next
Task V4: Full local validation
